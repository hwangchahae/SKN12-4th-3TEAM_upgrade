<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GitHub AI ì½”ë“œ ë¶„ì„</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track { 
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
            background-color: #1a202c !important;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
        
        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ê°œì„  */
        .msg-ai, .msg-user {
            display: flex;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-ai {
            justify-content: flex-start;
        }
        
        .msg-user {
            justify-content: flex-end;
        }
        
        .msg-ai > div {
            background-color: #2d3748;
            color: #f3f4f6; /* Added for better text readability */
            border-radius: 12px 12px 12px 0;
            max-width: 85%;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced readability for AI messages */
        .msg-ai > div p {
            margin-bottom: 0.8rem; /* Space between paragraphs */
            line-height: 1.65;    /* Space between lines within a paragraph */
        }
        .msg-ai > div ul, .msg-ai > div ol {
            margin-left: 1.5rem;  /* Indentation for lists */
            margin-bottom: 0.8rem;/* Space after lists */
            list-style-position: outside; /* Ensure bullets/numbers are outside the text flow */
        }
        .msg-ai > div ul {
            list-style-type: disc; /* Default bullet for unordered lists */
        }
        .msg-ai > div ol {
            list-style-type: decimal; /* Default numbering for ordered lists */
        }
        .msg-ai > div li {
            margin-bottom: 0.3rem; /* Space between list items */
        }
        .msg-ai > div strong, .msg-ai > div b { /* Make bold text slightly more prominent */
            color: #ffffff; 
            font-weight: 600;
        }
        .msg-ai > div em, .msg-ai > div i { /* Style for italic text */
            color: #e2e8f0; 
            font-style: italic;
        }

        .msg-user > div {
            background-color: #3b4a63;
            border-radius: 12px 12px 0 12px;
            max-width: 85%;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .msg-ai > div, .msg-user > div {
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* ì½”ë“œ ë¸”ë¡ ê°€ë…ì„± ê°œì„  ìŠ¤íƒ€ì¼ */
        .hljs {
            font-size: 14px;
            line-height: 1.5;
            padding: 1rem;
            border-radius: 8px;
            background-color: #1a202c !important;
            border: 1px solid #374151;
        }
        
        /* í•œê¸€ ì£¼ì„ ê°€ë…ì„± ê°œì„  */
        .hljs-comment {
            color: #8bbe9a !important;
            font-style: italic;
        }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .loading-wrapper {
          width: 80px;
          height: 30px;
          position: relative;
          z-index: 1;
          display: inline-block;
          margin-left: 5px;
        }

        .loading-circle {
          width: 8px;
          height: 8px;
          position: absolute;
          border-radius: 50%;
          background-color: #8b9cb3;
          left: 15%;
          transform-origin: 50%;
          animation: circle7124 .5s alternate infinite ease;
        }

        @keyframes circle7124 {
          0% {
            top: 30px;
            height: 3px;
            border-radius: 50px 50px 25px 25px;
            transform: scaleX(1.7);
          }

          40% {
            height: 20px;
            border-radius: 50%;
            transform: scaleX(1);
          }

          100% {
            top: 0%;
          }
        }

        .loading-circle:nth-child(2) {
          left: 45%;
          animation-delay: .2s;
        }

        .loading-circle:nth-child(3) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }

        .loading-shadow {
          width: 8px;
          height: 2px;
          border-radius: 50%;
          background-color: rgba(0,0,0,0.5);
          position: absolute;
          top: 32px;
          transform-origin: 50%;
          z-index: -1;
          left: 15%;
          filter: blur(1px);
          animation: shadow046 .5s alternate infinite ease;
        }

        @keyframes shadow046 {
          0% {
            transform: scaleX(1.5);
          }

          40% {
            transform: scaleX(1);
            opacity: .7;
          }

          100% {
            transform: scaleX(.2);
            opacity: .4;
          }
        }

        .loading-shadow:nth-child(4) {
          left: 45%;
          animation-delay: .2s
        }

        .loading-shadow:nth-child(5) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }
        
        /* GitHub í‘¸ì‹œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .github-push-btn {
            display: inline-flex;
            align-items: center;
            background-color: #238636;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 8px;
        }
        
        .github-push-btn:hover {
            background-color: #2ea043;
        }
        
        .github-push-btn:active {
            background-color: #238636;
        }
        
        /* ì½”ë“œ ìˆ˜ì • ì°½ ìŠ¤íƒ€ì¼ */
        .code-edit-container {
            background-color: #1a202c;
            border: 1px solid #374151;
            border-radius: 8px;
            margin-top: 16px;
            overflow: hidden;
        }
        
        .code-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #2d3748;
            border-bottom: 1px solid #374151;
        }
        
        .code-edit-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* íŒŒì¼ íƒìƒ‰ê¸° í† ê¸€ ì• ë‹ˆë©”ì´ì…˜ */
        #file-explorer {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        #show-file-explorer {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        #show-file-explorer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* íŒŒì¼ íƒìƒ‰ê¸° ìˆ¨ê¹€ ìƒíƒœ ê°œì„  */
        #show-file-explorer .material-icons {
            font-size: 20px;
        }
        
        /* ì„¸ë¡œ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ê°œì„  */
        .writing-mode-vertical {
            line-height: 1.2;
        }
        
        .writing-mode-vertical div {
            margin-bottom: 2px;
            font-weight: 500;
        }


    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen">
<div class="flex flex-col min-h-screen">
<!-- ìƒë‹¨ í—¤ë” -->
<header class="bg-gray-800 p-3 flex items-center justify-between border-b border-gray-700" style="height: 70px;">
  <div class="flex items-center">
    <img src="/static/logo.jpg" alt="logo" class="h-36 w-36 object-contain mr-3" />
    <h1 class="text-white font-semibold text-xl"></h1>
  </div>
  <div class="flex items-center">
    <div id="repo-status" class="text-blue-300 mr-4 text-sm">ì €ì¥ì†Œ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸í•´ì£¼ì„¸ìš”!</div>
    <img alt="User avatar" class="w-8 h-8 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuC8ljbNzHJUH9ZC9WD5AFSxwpOS3_ZcKoBsLH4ppNnwv7l3PC3qZkbjVVuRXDv_LB2aLAVzFpGwFvpgU939wCp2HDeAroJdPNVKcOjo-5whV-vaimG-X5ivF_RqhmCDcnM2Bi5WXW47zGRSkP87NchAS8fDloSnEPGY0npOYffb2D5qh2IzUJZUTY6fiJmDe041cG7cQk4McvdpSkgvIh0XcwZREUgolNXnwo0yjX29hajqa2PMtaJeo8ic779fqzftRvUOJJdkRck"/>
  </div>
</header>

<!-- ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ - ë„¤ë¹„ê²Œì´í„°ì™€ ì±„íŒ… ì˜ì—­ìœ¼ë¡œ ë¶„ë¦¬ -->
<div class="flex flex-1">
  <!-- ì™¼ìª½ ì±„íŒ… ë„¤ë¹„ê²Œì´í„° -->
  <div class="bg-gray-800 w-64 border-r border-gray-700 flex-shrink-0 flex flex-col">
    <div class="p-3 flex justify-between items-center border-b border-gray-700">
      <div class="text-lg font-semibold text-white">ì±„íŒ… ëª©ë¡</div>
      <div class="flex">
        <button id="new-chat-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200 flex items-center">
          <span class="material-icons text-sm mr-1">add</span>ìƒˆ ì±„íŒ…
        </button>
        <a href="/" class="ml-2 bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200 flex items-center" title="ë‹¤ë¥¸ ë ˆí¬ì§€í† ë¦¬ ë¶„ì„">
          <span class="material-icons text-sm mr-1">home</span>í™ˆ
        </a>
      </div>
    </div>
    
    <!-- ì„¸ì…˜ ê´€ë¦¬ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
    <div class="p-2 flex justify-between items-center border-b border-gray-700">
      <div class="text-sm text-gray-300">ì„¸ì…˜ ê´€ë¦¬</div>
      <label class="inline-flex items-center cursor-pointer">
        <input type="checkbox" id="edit-mode-toggle" class="sr-only peer">
        <div class="relative w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
      </label>
    </div>
    
    <!-- ì„¸ì…˜ ëª©ë¡ -->
    <div id="chat-sessions-list" class="flex-1 overflow-y-auto p-2">
      {% if chat_sessions %}
        {% for chat_session in chat_sessions %}
          <div class="chat-session-item p-2 rounded-md cursor-pointer hover:bg-gray-700 transition-colors duration-150 mb-1 relative {% if chat_session.session_id == session_id %}bg-gray-700{% endif %}" data-session-id="{{ chat_session.session_id }}">
            <div class="flex justify-between items-center">
              <div class="text-sm font-medium truncate chat-session-name">ì±„íŒ… #{{ loop.index }}</div>
              <div class="text-xs text-gray-400">{{ chat_session.created_at.strftime('%Y-%m-%d') }}</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">
              ë©”ì‹œì§€: {{ chat_session.message_count if chat_session.message_count is not none else 0 }}ê°œ
            </div>
            
            <!-- ì„¸ì…˜ ê´€ë¦¬ ë²„íŠ¼ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
            <div class="session-controls absolute right-1 top-1 hidden">
              <button class="rename-session text-xs bg-blue-600 hover:bg-blue-700 text-white p-1 rounded" title="ì´ë¦„ ë³€ê²½">
                <span class="material-icons" style="font-size: 14px;">edit</span>
              </button>
              <button class="move-up-session text-xs bg-gray-600 hover:bg-gray-700 text-white p-1 rounded" title="ìœ„ë¡œ ì´ë™">
                <span class="material-icons" style="font-size: 14px;">arrow_upward</span>
              </button>
              <button class="move-down-session text-xs bg-gray-600 hover:bg-gray-700 text-white p-1 rounded" title="ì•„ë˜ë¡œ ì´ë™">
                <span class="material-icons" style="font-size: 14px;">arrow_downward</span>
              </button>
              <button class="export-md-session text-xs bg-green-600 hover:bg-green-700 text-white p-1 rounded" title="MD íŒŒì¼ë¡œ ì¶”ì¶œ">
                <span class="material-icons" style="font-size: 14px;">download</span>
              </button>
              <button class="delete-session text-xs bg-red-600 hover:bg-red-700 text-white p-1 rounded" title="ì‚­ì œ">
                <span class="material-icons" style="font-size: 14px;">delete</span>
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-sm text-gray-500 italic p-2">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
      {% endif %}
    </div>
    
    <!-- í˜„ì¬ ì €ì¥ì†Œ ì •ë³´ -->
    <div class="p-3 bg-gray-700 border-t border-gray-600">
      <div class="text-xs text-gray-400 mb-1">í˜„ì¬ ì €ì¥ì†Œ:</div>
      <div class="text-sm font-medium truncate" title="{{ repo_url }}">{{ repo_url }}</div>
    </div>
  </div>

      <!-- ì¤‘ê°„ íŒŒì¼ íƒìƒ‰ ì‚¬ì´ë“œë°” -->
  <div id="file-explorer" class="bg-gray-800 w-80 border-r border-gray-700 flex-shrink-0 flex flex-col">
    <!-- ì„¸ì…˜ ê´€ë¦¬ ë„êµ¬ -->
    <div class="p-3 border-b border-gray-700">
      <div class="text-sm font-semibold text-white mb-2">ì„¸ì…˜ ê´€ë¦¬</div>
      <button id="cleanup-context-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-1 px-3 rounded text-sm mb-2">
        <span class="material-icons text-sm mr-1">cleaning_services</span>ì±„íŒ… ê¸°ë¡ ì •ë¦¬
      </button>
    </div>
    
    <!-- ë¸Œëœì¹˜ ì„ íƒ -->
    <div class="p-3 border-b border-gray-700">
      <div class="text-sm font-semibold text-white mb-2">ë¸Œëœì¹˜ ì„ íƒ</div>
      <select id="branch-selector" class="w-full bg-gray-700 border border-gray-600 text-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>
      </select>
    </div>
    
    <!-- íŒŒì¼ íŠ¸ë¦¬ -->
    <div class="flex-1 overflow-y-auto">
      <div class="p-3 border-b border-gray-700">
        <div class="text-sm font-semibold text-white mb-2">íŒŒì¼ êµ¬ì¡°</div>
        <div id="file-tree-loading" class="text-xs text-gray-400 hidden">íŒŒì¼ êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
      <div id="file-tree" class="p-2">
        <div class="text-xs text-gray-500 italic p-2">ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ êµ¬ì¡°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
      </div>
    </div>
    
    <!-- íŒŒì¼ íƒìƒ‰ê¸° í† ê¸€ ë²„íŠ¼ -->
    <div class="p-2 border-t border-gray-700">
      <button id="toggle-file-explorer" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-md text-sm transition-colors duration-200">
        <span class="material-icons text-sm mr-1">visibility_off</span>íŒŒì¼ íƒìƒ‰ê¸° ìˆ¨ê¸°ê¸°
      </button>
    </div>
  </div>

  <!-- íŒŒì¼ íƒìƒ‰ê¸° í† ê¸€ ë²„íŠ¼ (ìˆ¨ê²¨ì§„ ìƒíƒœì—ì„œ ë³´ì´ëŠ” ë²„íŠ¼) -->
  <div id="show-file-explorer" class="bg-gray-800 border-r border-gray-600 w-16 flex-shrink-0 flex flex-col items-center justify-center py-4" style="display: none;">
    <button id="show-file-explorer-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg transition-all duration-200 shadow-lg mb-3" title="íŒŒì¼ íƒìƒ‰ê¸° ë³´ì´ê¸°">
      <span class="material-icons text-lg">folder_open</span>
    </button>
    <div class="text-xs text-gray-400 writing-mode-vertical text-center">
      <div>íŒŒ</div>
      <div>ì¼</div>
      <div>íƒ</div>
      <div>ìƒ‰</div>
      <div>ê¸°</div>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
  <div class="flex-1 flex flex-col">
    <!-- MD íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ (í•­ìƒ í‘œì‹œ) -->
    <div class="bg-gray-700 border-b border-gray-600 p-3">
      <div class="flex justify-between items-center">
        <div class="text-sm font-semibold text-white">ì§ˆë¬¸ ì»¨í…ìŠ¤íŠ¸</div>
        <div class="flex gap-2">
          <label for="md-file-upload" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs cursor-pointer flex items-center">
            <span class="material-icons text-xs mr-1">upload_file</span>MD ì¶”ê°€
          </label>
          <input type="file" id="md-file-upload" accept=".md,.txt" style="display: none;">
          <button id="clear-selected-files" class="text-gray-400 hover:text-white text-sm" style="display: none;">
            <span class="material-icons text-sm">clear_all</span> ëª¨ë‘ ì œê±°
          </button>
        </div>
      </div>
      <div id="selected-files-list" class="flex flex-wrap gap-2 mt-2" style="display: none;"></div>
    </div>

  <!-- ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
  <div id="chat-box" class="flex-1 p-6 overflow-y-auto bg-gray-900" style="min-height:calc(100vh - 150px);">
    <!-- ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    <div class="msg-ai mb-6">
      <div>
        <p>ì•ˆë…•í•˜ì„¸ìš”! GitHub ì €ì¥ì†Œì˜ ì½”ë“œì— ëŒ€í•´ ì§ˆë¬¸í•˜ê±°ë‚˜ ì½”ë“œ ìˆ˜ì •ì„ ìš”ì²­í•´ë³´ì„¸ìš”. ì–¸ì œë“ ì§€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! íŒŒì¼ êµ¬ì¡°, í•¨ìˆ˜ì˜ ëª©ì , ë²„ê·¸ í•´ê²° ë°©ë²• ë“± ì–´ë–¤ ì§ˆë¬¸ì´ë“  ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
          <p class="mt-2 text-sm text-gray-400">ğŸ’¡ ì™¼ìª½ íŒŒì¼ íƒìƒ‰ê¸°ì—ì„œ ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ê³  íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <p class="mt-2 text-sm text-blue-400">ğŸ” íŒŒì¼ì„ ìš°í´ë¦­í•˜ì—¬ ì§ˆë¬¸ ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </div>
    </div>
  </div>
  
  <!-- ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
  <div id="code-preview" class="bg-gray-800 border-t border-gray-700 p-4 overflow-y-auto" style="max-height:40vh; display:none;">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-white font-medium"></h3>
        <div class="flex gap-2">
          <button id="fullscreen-preview" class="text-gray-400 hover:text-white" title="ì „ì²´ í™”ë©´ìœ¼ë¡œ ë³´ê¸°">
            <span class="material-icons">fullscreen</span>
          </button>
      <button id="close-preview" class="text-gray-400 hover:text-white">
        <span class="material-icons">close</span>
      </button>
        </div>
    </div>
    <div id="code-preview-content"></div>
    </div>
  </div>
</div>

<!-- ì „ì²´ í™”ë©´ ì½”ë“œ ë·°ì–´ ëª¨ë‹¬ -->
<div id="fullscreen-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden">
  <div class="flex flex-col h-full">
    <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-600">
      <h2 id="fullscreen-title" class="text-white font-medium text-lg"></h2>
      <div class="flex gap-2">
        <button id="add-to-context-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
          <span class="material-icons text-sm mr-1">add</span>ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€
        </button>
        <button id="close-fullscreen" class="text-gray-400 hover:text-white">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>
    <div id="fullscreen-content" class="flex-1 overflow-auto bg-gray-900 p-4"></div>
  </div>
  </div>
  
  <!-- ì…ë ¥ í¼ ì˜ì—­ -->
  <div class="bg-gray-800 border-t border-gray-700 p-4">
    <form id="chat-form" class="flex gap-2">
      <input type="text" class="flex-1 bg-gray-700 border border-gray-600 text-gray-200 rounded-md py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-input" placeholder="ì§ˆë¬¸ ë˜ëŠ” ì½”ë“œ ìˆ˜ì • ìš”ì²­ ì…ë ¥..." autocomplete="off" required>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md transition-all duration-200">ì „ì†¡</button>
    </form>
  </div>
  </div>
</div>
</div>

<script>
const chatBox = document.getElementById('chat-box');
const codePreview = document.getElementById('code-preview'); // This might be unused now
let lastFileName = '';
let lastModifiedCode = '';

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function styleCodeBlock(el) {
    if (!el.classList.contains('hljs')) {
        hljs.highlightElement(el);
    }

    el.style.backgroundColor = '#1e1e1e'; 
    el.style.color = '#ffffff';
    el.style.padding = '1rem'; // Consistent padding for code content
    el.style.fontSize = '14px';
    el.style.lineHeight = '1.6';
    el.style.border = '1px solid #333';
    el.style.borderRadius = '6px';
    el.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
    el.style.whiteSpace = 'pre-wrap'; // Ensure wrapping
    el.style.wordBreak = 'break-all'; // Ensure long words break

    const parentPre = el.parentElement;
    if (parentPre && parentPre.tagName === 'PRE') {
        parentPre.style.backgroundColor = '#1a202c'; 
        parentPre.style.padding = '0'; // Padding is now on the <code> element
        parentPre.style.borderRadius = '8px';
        parentPre.style.margin = '0.5rem 0';
        parentPre.classList.add('overflow-auto', 'max-h-96'); // For scrollability and max height
        parentPre.style.position = 'relative'; // For copy button positioning
    }

    const keywords = el.querySelectorAll('.hljs-keyword, .hljs-selector-tag, .hljs-built_in, .hljs-tag');
    const strings = el.querySelectorAll('.hljs-string, .hljs-regexp, .hljs-selector-attr');
    const comments = el.querySelectorAll('.hljs-comment, .hljs-quote');
    const functions = el.querySelectorAll('.hljs-function, .hljs-title, .hljs-section');
    const numbers = el.querySelectorAll('.hljs-number, .hljs-literal');
    const variables = el.querySelectorAll('.hljs-variable, .hljs-params, .hljs-class');
    
    keywords.forEach(elem => { elem.style.color = '#569CD6'; elem.style.fontWeight = 'bold'; });
    strings.forEach(elem => { elem.style.color = '#CE9178'; });
    comments.forEach(elem => { elem.style.color = '#6A9955'; elem.style.fontStyle = 'italic'; });
    functions.forEach(elem => { elem.style.color = '#DCDCAA'; });
    numbers.forEach(elem => { elem.style.color = '#B5CEA8'; });
    variables.forEach(elem => { elem.style.color = '#9CDCFE'; });

    if (parentPre && !parentPre.querySelector('.copy-btn')) {
        const btn = document.createElement('button');
        btn.className = 'copy-btn absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded px-2 py-1 text-xs transition-all';
        btn.innerText = 'ë³µì‚¬';
        btn.onclick = function() {
            navigator.clipboard.writeText(el.innerText);
            btn.innerText = 'ë³µì‚¬ë¨!';
            setTimeout(()=>{btn.innerText='ë³µì‚¬';}, 1500);
        };
        parentPre.appendChild(btn);
    }
}

function isModifyRequest(text) {
    // ê°„ë‹¨í•œ ê·œì¹™: "ê³ ì³ì¤˜", "ìˆ˜ì •", "ì¶”ê°€", "ë³€ê²½" ë“± í¬í•¨ ì‹œ ìˆ˜ì • ìš”ì²­ìœ¼ë¡œ ê°„ì£¼
    return /ê³ ì³ì¤˜|ìˆ˜ì •|ì¶”ê°€|ë³€ê²½|ë¦¬íŒ©í„°|refactor|fix|add|modify/i.test(text);
}

// ìƒˆ ì±„íŒ… ìƒì„± ê¸°ëŠ¥
document.getElementById('new-chat-btn').addEventListener('click', async function() {
    const button = this;
    const originalText = button.innerHTML;
    
    try {
        // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
        button.disabled = true;
        button.innerHTML = '<span class="material-icons text-sm mr-1 animate-spin">refresh</span>ìƒì„± ì¤‘...';
        
        const response = await fetch('/new-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                repo_url: '{{ repo_url }}',
                token: '{{ token }}' // í•„ìš”ì‹œ í† í° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²• ë³€ê²½
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'ì„±ê³µ') {
            showToast('ìƒˆ ì±„íŒ…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
            
            // ìƒˆ ì±„íŒ… ì„¸ì…˜ìœ¼ë¡œ ì´ë™í•˜ë˜ ê¸°ì¡´ ì±„íŒ… ê¸°ë¡ì€ ìœ ì§€ë¨
            // history.pushState ì‚¬ìš©ìœ¼ë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì—†ì´ URLë§Œ ë³€ê²½
            const newUrl = `/chat/${result.session_id}`;
            history.pushState({session_id: result.session_id}, '', newUrl);
            
            // ì±„íŒ…ì°½ ì´ˆê¸°í™”
            document.getElementById('chat-box').innerHTML = `
            <div class="msg-ai mb-6">
              <div>
                <p>ì•ˆë…•í•˜ì„¸ìš”! GitHub ì €ì¥ì†Œì˜ ì½”ë“œì— ëŒ€í•´ ì§ˆë¬¸í•˜ê±°ë‚˜ ì½”ë“œ ìˆ˜ì •ì„ ìš”ì²­í•´ë³´ì„¸ìš”. ì–¸ì œë“ ì§€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! íŒŒì¼ êµ¬ì¡°, í•¨ìˆ˜ì˜ ëª©ì , ë²„ê·¸ í•´ê²° ë°©ë²• ë“± ì–´ë–¤ ì§ˆë¬¸ì´ë“  ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
              </div>
            </div>`;
            
            // ì±„íŒ… ì„¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
            updateChatSessionsList(result.session_id);
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('user-input').value = '';
            
        } else if (result.error_code === 'repo_not_analyzed') {
            // ë¶„ì„ë˜ì§€ ì•Šì€ ì €ì¥ì†Œì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
            const shouldAnalyze = confirm(
                `${result.error}\n\nì €ì¥ì†Œë¥¼ ë¶„ì„í•˜ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?`
            );
            if (shouldAnalyze) {
                window.location.href = '/';
            }
        } else {
            // ë‹¤ë¥¸ ì˜¤ë¥˜ì˜ ê²½ìš° ë” ìì„¸í•œ ì •ë³´ ì œê³µ
            let errorMessage = 'ìƒˆ ì±„íŒ… ìƒì„± ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            if (result.error && result.error.includes('ChromaDB')) {
                errorMessage += '\n\nğŸ’¡ í•´ê²° ë°©ë²•:\n1. ê¸°ì¡´ ì±„íŒ… ì„¸ì…˜ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”\n2. ì €ì¥ì†Œë¥¼ ë‹¤ì‹œ ë¶„ì„í•´ë³´ì„¸ìš”\n3. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”';
            }
            alert(errorMessage);
        }
    } catch (error) {
        console.error('ìƒˆ ì±„íŒ… ìƒì„± ì˜¤ë¥˜:', error);
        alert('ìƒˆ ì±„íŒ… ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    } finally {
        // ë²„íŠ¼ ìƒíƒœ ë³µì›
        button.disabled = false;
        button.innerHTML = originalText;
    }
});

// ì±„íŒ… ì„¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updateChatSessionsList(currentSessionId) {
    try {
        // ì±„íŒ… ì„¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const response = await fetch(`/chat-sessions?repo_url={{ repo_url }}`);
        const result = await response.json();
        
        if (result.status === 'ì„±ê³µ' && result.chat_sessions) {
            const chatSessionsList = document.getElementById('chat-sessions-list');
            chatSessionsList.innerHTML = '';
            
            if (result.chat_sessions.length === 0) {
                chatSessionsList.innerHTML = '<div class="text-sm text-gray-500 italic p-2">ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            // ì±„íŒ… ì„¸ì…˜ ëª©ë¡ í‘œì‹œ
            result.chat_sessions.forEach((chatSession, index) => {
                const isActive = chatSession.session_id === currentSessionId;
                const sessionItem = document.createElement('div');
                sessionItem.className = `chat-session-item p-2 rounded-md cursor-pointer hover:bg-gray-700 transition-colors duration-150 ${isActive ? 'bg-gray-700' : ''}`;
                sessionItem.dataset.sessionId = chatSession.session_id;
                
                const date = new Date(chatSession.created_at);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                sessionItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="text-sm font-medium truncate">ì±„íŒ… #${index + 1}</div>
                        <div class="text-xs text-gray-400">${formattedDate}</div>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        ë©”ì‹œì§€: ${chatSession.message_count !== null ? chatSession.message_count : 0}ê°œ
                    </div>
                `;
                
                // ì±„íŒ… ì„¸ì…˜ í´ë¦­ ì´ë²¤íŠ¸
                sessionItem.addEventListener('click', function() {
                    window.location.href = `/chat/${chatSession.session_id}`;
                });
                
                chatSessionsList.appendChild(sessionItem);
            });
        } else {
            console.error('ì±„íŒ… ì„¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        }
    } catch (error) {
        console.error('ì±„íŒ… ì„¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
}

// ê¸°ì¡´ ì±„íŒ… ì„¸ì…˜ ì•„ì´í…œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
document.querySelectorAll('.chat-session-item').forEach(item => {
    item.addEventListener('click', function() {
        const sessionId = this.dataset.sessionId;
        if (sessionId) {
            window.location.href = `/chat/${sessionId}`;
        }
    });
});

// ê¸°ì¡´ ì±„íŒ… ê¸°ëŠ¥
document.getElementById('chat-form').onsubmit = async function(e) {
    e.preventDefault();
    const input = document.getElementById('user-input');
    const userMsg = input.value;
    
    // ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ë¨¼ì € ìƒì„±
    let contextInfo = '';
    if (selectedFiles.length > 0) {
        contextInfo = selectedFiles.map(file => file.path).join(', ');
    }
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ (ì»¨í…ìŠ¤íŠ¸ ì •ë³´ í¬í•¨)
    let userMessageHtml = `<div class="msg-user flex justify-end mb-2"><div class="bg-gray-700 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-yellow-300">ë‚˜:</b> ${escapeHtml(userMsg)}`;
    
    if (contextInfo) {
        userMessageHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-300"><span class="material-icons text-xs mr-1">description</span>ì„ íƒëœ íŒŒì¼: ${escapeHtml(contextInfo)}</div>`;
    }
    
    userMessageHtml += `</div></div>`;
    chatBox.innerHTML += userMessageHtml;
    input.value = '';
    
    // ì§ˆë¬¸ í›„ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
    // ë©”ì‹œì§€ ì „ì†¡ í›„ ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ (ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì‚­ì œí•  ë•Œê¹Œì§€)
    // selectedFilesë¥¼ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒìœ¼ë¡œì¨ ì—°ì†ì ì¸ ì§ˆë¬¸ ì‹œ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
    console.log('[DEBUG] ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ, ì»¨í…ìŠ¤íŠ¸ ìœ ì§€:', selectedFiles.length, 'ê°œ íŒŒì¼');
    
    // AI ì‘ë‹µ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
    const loadingId = 'loading-' + Date.now();
    chatBox.innerHTML += `
      <div id="${loadingId}" class="msg-ai flex justify-start mb-2">
        <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow">
          <b class="text-blue-300">AI:</b>
          <div class="loading-wrapper">
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
          </div>
        </div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    let url = '/chat';
    if (isModifyRequest(userMsg)) url = '/modify_request';
    // ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ í¬í•¨í•˜ì—¬ ë©”ì‹œì§€ êµ¬ì„±
    let messageWithContext = userMsg;
    if (selectedFiles.length > 0) {
        messageWithContext += '\n\n[ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸]\n';
        selectedFiles.forEach(file => {
            messageWithContext += `\n--- ${file.path} (ë¸Œëœì¹˜: ${file.branch}) ---\n`;
            messageWithContext += file.content + '\n';
        });
    }
    
    const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: '{{ session_id }}',
            message: messageWithContext
        })
    });
    const data = await res.json();
    // ì„¸ì…˜ ì˜¤ë¥˜ ì²˜ë¦¬
    if (data.error === 'session_not_found' || data.error === 'search_error') {
        chatBox.innerHTML += `<div class="bg-red-500 text-white rounded-lg p-4 my-2 text-center"><b>AI:</b> ${marked.parse(data.answer)}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        setTimeout(() => {
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
            window.location.href = '/';
        }, 3000);
        return;
    }
    // ì¼ë°˜ ì‘ë‹µ ì²˜ë¦¬
    if (data.answer) {
        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // AI ì‘ë‹µ ì¶”ê°€
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${marked.parse(data.answer)} </div></div>`;
        // ìƒˆë¡œ ì¶”ê°€ëœ ë©”ì‹œì§€ ë‚´ì˜ ëª¨ë“  ì½”ë“œ ë¸”ë¡ì— ìŠ¤íƒ€ì¼ ì ìš©
        document.querySelectorAll('#chat-box .msg-ai:last-child pre code').forEach(styleCodeBlock);
    }
    // ì½”ë“œ ìˆ˜ì • ì²˜ë¦¬
    if (data.modified_code) {
        // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±°
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // ì´ì „ codePreview ìš”ì†ŒëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬ (ë˜ëŠ” ì™„ì „íˆ ì œê±° ê°€ëŠ¥)
        const oldCodePreviewEl = document.getElementById('code-preview');
        if (oldCodePreviewEl) oldCodePreviewEl.style.display = 'none';
        
        lastFileName = data.file_name || '';
        lastModifiedCode = data.modified_code || ''; // ì›ë³¸ ì½”ë“œëŠ” HTML ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ ì˜ˆì •
        const checkPushRes = await fetch('/check_push_intent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: '{{ session_id }}',
                message: userMsg
            })
        });
        const pushData = await checkPushRes.json();
        const hasPushIntent = pushData.has_push_intent;
        const hasToken = pushData.token_exists;
        let actionButtons = '';
        if (hasPushIntent) {
            if (hasToken) {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>ë¡œì»¬ì—ë§Œ ì ìš©</button>
                        <button id='push-btn' class='bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>GitHubì— ì ìš©(push)</button>
                    </div>
                    <div id="confirmation-msg" class="bg-blue-100 text-blue-900 rounded-lg p-4 my-2" style="display:none;">
                        <p class="font-bold mb-2">GitHub ì €ì¥ì†Œì— ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <p>ë¸Œëœì¹˜: <code>test</code> | íŒŒì¼: <code>${lastFileName}</code></p>
                        <div class="flex gap-2 mt-2">
                            <button id="confirm-push" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200">ì ìš©</button>
                            <button id="cancel-push" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200">ì·¨ì†Œ</button>
                        </div>
                    </div>`;
            } else {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>ë¡œì»¬ì—ë§Œ ì ìš©</button>
                    </div>
                    <div class="bg-yellow-100 text-yellow-900 rounded-lg p-4 my-2">
                        <strong>GitHub ë°˜ì˜ ê¸°ëŠ¥ì€ í† í° ì…ë ¥ ì‹œì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</strong><br>
                        ì‹œì‘ í™”ë©´ì—ì„œ GitHub Personal Access Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
                    </div>`;
            }
        } else {
            actionButtons = `
                <div class="flex gap-2 mb-3">
                    <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>ì ìš©</button>
                </div>`;
        }
        // ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ë‚´ìš©ì„ ì±„íŒ…ì°½ì— ì¶”ê°€
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2">
            <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[90%] font-medium shadow" style="overflow-wrap: break-word; word-break: break-word;">
              <b class="text-blue-300">AI:</b> ì•„ë˜ì™€ ê°™ì´ ì½”ë“œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤:
              <div class="mb-2 mt-3 text-gray-300"><b>íŒŒì¼ëª…:</b> ${lastFileName}</div>
              <pre><code class="language-python">${escapeHtml(lastModifiedCode)}</code></pre>
              ${actionButtons}
            </div>
          </div>`;
        // ìƒˆë¡œ ì¶”ê°€ëœ ë©”ì‹œì§€ ë‚´ì˜ ëª¨ë“  ì½”ë“œ ë¸”ë¡ì— ìŠ¤íƒ€ì¼ ì ìš©
        document.querySelectorAll('#chat-box .msg-ai:last-child pre code').forEach(styleCodeBlock);
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        chatBox.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'close-preview-btn') {
                // ë¯¸ë¦¬ë³´ê¸°ë¥¼ ë‹«ëŠ” ê¸°ëŠ¥ì€ ë” ì´ìƒ í•„ìš”í•˜ì§€ ì•Šì§€ë§Œ, ë²„íŠ¼ì´ ìˆì„ ê²½ìš° ì˜¤ë¥˜ ë°©ì§€
                codePreview.style.display = 'none';
            }
        });
        
        // GitHub í‘¸ì‹œ ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„
        // GitHub í‘¸ì‹œ ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„ - ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©í•˜ì—¬ ë™ì  ìƒì„±ëœ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì ìš©
        chatBox.addEventListener('click', function(e) {
            // í‘¸ì‹œ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (e.target && e.target.id === 'push-btn') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'block';
            }
            
            // í™•ì¸ ë²„íŠ¼ ì²˜ë¦¬ - ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
            // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (e.target && e.target.id === 'confirm-push') {
                // ì¶”ê°€ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ë¡œë”© IDê°€ ì—†ì„ ìˆ˜ ìˆì–´ì„œ ëª¨ë“  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±°)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                
                (async function() {
                    try {
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = true;
                            pushBtn.innerText = 'ì²˜ë¦¬ ì¤‘...';
                        }
                        
                        const pushRes = await fetch('/push_to_github', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                session_id: '{{ session_id }}',
                                file_name: lastFileName,
                                modified_code: lastModifiedCode
                            })
                        });
                        
                        const result = await pushRes.json();
                        
                        if (result.success) {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                                  GitHubì— ì„±ê³µì ìœ¼ë¡œ ì½”ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
                                </div>
                              </div>`;
                        } else {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">error</i>
                                  GitHub ì ìš© ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                                </div>
                              </div>`;
                        }
                    } catch (error) {
                        console.error('GitHub í‘¸ì‹œ ì˜¤ë¥˜:', error);
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              GitHub ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                            </div>
                          </div>`;
                    } finally {
                        const confirmMsg = document.getElementById('confirmation-msg');
                        if (confirmMsg) confirmMsg.style.display = 'none';
                        
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = false;
                            pushBtn.innerText = 'GitHubì— ì ìš©(push)';
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                })();
            }
            
            // ì·¨ì†Œ ë²„íŠ¼ ì²˜ë¦¬
            if (e.target && e.target.id === 'cancel-push') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'none';
            }
        });
        
        // ë¡œì»¬ ì ìš© ë²„íŠ¼ ê¸°ëŠ¥ êµ¬í˜„ - ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©
        chatBox.addEventListener('click', async function(e) {
            // ë¡œì»¬ ì ìš© ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            if (e.target && e.target.id === 'apply-btn') {
                // ì¶”ê°€ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±° (ë¡œë”© IDê°€ ì—†ì„ ìˆ˜ ìˆì–´ì„œ ëª¨ë“  ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ ì œê±°)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                try {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = true;
                        applyBtn.innerText = 'ì ìš© ì¤‘...';
                    }
                    
                    const applyRes = await fetch('/apply_local', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: '{{ session_id }}',
                            file_name: lastFileName,
                            modified_code: lastModifiedCode
                        })
                    });
                    
                    const result = await applyRes.json();
                    
                    if (result.success) {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                              ë¡œì»¬ì— ì„±ê³µì ìœ¼ë¡œ ì½”ë“œê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.
                            </div>
                          </div>`;
                    } else {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              ë¡œì»¬ ì ìš© ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}
                            </div>
                          </div>`;
                    }
                } catch (error) {
                    console.error('ë¡œì»¬ ì ìš© ì˜¤ë¥˜:', error);
                    chatBox.innerHTML += `
                      <div class="msg-system flex justify-center my-3">
                        <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                          <i class="material-icons align-middle text-sm mr-1">error</i>
                          ë¡œì»¬ ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                        </div>
                      </div>`;
                } finally {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = false;
                        applyBtn.innerText = 'ë¡œì»¬ì—ë§Œ ì ìš©';
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });
        }
    chatBox.scrollTop = chatBox.scrollHeight;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
window.addEventListener('load', async function() {
    try {
        // ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        const response = await fetch(`/get_chat_history?session_id={{ session_id }}`);
        const result = await response.json();
        
        if (result.status === 'ì„±ê³µ' && result.chat_history && result.chat_history.length > 0) {
            // ì±„íŒ… ê¸°ë¡ í‘œì‹œ
            chatBox.innerHTML = ''; // ê¸°ì¡´ ì›°ì»´ ë©”ì‹œì§€ ì œê±°
            
            // ì±„íŒ… ë‚´ì—­ì´ ì—†ëŠ” ê²½ìš° í‘œì‹œí•  ë©”ì‹œì§€
            if (result.chat_history.length === 0) {
                chatBox.innerHTML += `<div class="msg-ai mb-6">
                    <div>
                        <p>ì•ˆë…•í•˜ì„¸ìš”! GitHub ì €ì¥ì†Œì˜ ì½”ë“œì— ëŒ€í•´ ì§ˆë¬¸í•˜ê±°ë‚˜ ì½”ë“œ ìˆ˜ì •ì„ ìš”ì²­í•´ë³´ì„¸ìš”. ì–¸ì œë“ ì§€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! íŒŒì¼ êµ¬ì¡°, í•¨ìˆ˜ì˜ ëª©ì , ë²„ê·¸ í•´ê²° ë°©ë²• ë“± ì–´ë–¤ ì§ˆë¬¸ì´ë“  ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
  </div>
                </div>`;
            } else {
                result.chat_history.forEach(msg => {
                    try {
                        if (msg.role === 'user') {
                            // ì‚¬ìš©ì ë©”ì‹œì§€ - ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ë¶„ë¦¬ ì²˜ë¦¬
                            let userMessage = msg.content;
                            let contextInfo = '';
                            
                            console.log(`[DEBUG] ì›ë³¸ ì‚¬ìš©ì ë©”ì‹œì§€:`, userMessage);
                            
                                        // ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ì¶œ ë° ì²˜ë¦¬ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            if (userMessage.includes('[ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸]')) {
                // íŒ¨í„´ 1: [ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸] í˜•ì‹
                console.log('[DEBUG] íŒ¨í„´ 1 ë§¤ì¹­: [ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸]');
                const parts = userMessage.split('\n\n[ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸]\n');
                if (parts.length > 1) {
                    userMessage = parts[0];  // ì§ˆë¬¸ ë¶€ë¶„ë§Œ
                    const contextPart = parts[1];
                    
                    // "--- íŒŒì¼ëª… (ë¸Œëœì¹˜: ë¸Œëœì¹˜ëª…) ---" íŒ¨í„´ì—ì„œ íŒŒì¼ëª…ë§Œ ì¶”ì¶œ
                    const fileMatches = contextPart.match(/--- (.+?) \(ë¸Œëœì¹˜: .+?\) ---/g);
                    if (fileMatches) {
                        const fileNames = fileMatches.map(match => {
                            const fileName = match.match(/--- (.+?) \(ë¸Œëœì¹˜:/)[1];
                            return fileName.trim();
                        }).filter(file => file);
                        contextInfo = fileNames.join(', ');
                    }
                }
            }
            // íŒ¨í„´ 2: "[ì„ íƒëœ íŒŒì¼: íŒŒì¼ëª…]" í˜•ì‹ (ê¸°ì¡´ ì €ì¥ í˜•ì‹)
            else if (userMessage.includes('[ì„ íƒëœ íŒŒì¼:')) {
                console.log('[DEBUG] íŒ¨í„´ 2 ë§¤ì¹­: [ì„ íƒëœ íŒŒì¼:]');
                const contextMatch = userMessage.match(/\[ì„ íƒëœ íŒŒì¼:\s*([^\]]+)\]/);
                if (contextMatch) {
                    contextInfo = contextMatch[1].trim();
                    // ë©”ì‹œì§€ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì œê±°í•˜ì—¬ ì§ˆë¬¸ ë¶€ë¶„ë§Œ í‘œì‹œ
                    userMessage = userMessage.replace(/\n*\[ì„ íƒëœ íŒŒì¼:[^\]]+\]/g, '').trim();
                }
            }
            // íŒ¨í„´ 3: "[ì»¨í…ìŠ¤íŠ¸ íŒŒì¼: íŒŒì¼ëª…]" í˜•ì‹ (ìƒˆë¡œìš´ ì €ì¥ í˜•ì‹)
            else if (userMessage.includes('[ì»¨í…ìŠ¤íŠ¸ íŒŒì¼:')) {
                console.log('[DEBUG] íŒ¨í„´ 3 ë§¤ì¹­: [ì»¨í…ìŠ¤íŠ¸ íŒŒì¼:]');
                const contextMatch = userMessage.match(/\[ì»¨í…ìŠ¤íŠ¸ íŒŒì¼:\s*([^\]]+)\]/);
                if (contextMatch) {
                    contextInfo = contextMatch[1].trim();
                    // ë©”ì‹œì§€ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì œê±°í•˜ì—¬ ì§ˆë¬¸ ë¶€ë¶„ë§Œ í‘œì‹œ
                    userMessage = userMessage.replace(/\n*\[ì»¨í…ìŠ¤íŠ¸ íŒŒì¼:[^\]]+\]/g, '').trim();
                }
            }
            // íŒ¨í„´ 4: ì‹¤ì œ ì»¨í…ìŠ¤íŠ¸ ë‚´ìš©ì´ í¬í•¨ëœ ê²½ìš° (ì‚¬ìš©ìê°€ ì§ì ‘ ì„ íƒí•œ ê²½ìš°)
            else if (userMessage.includes('--- ') && userMessage.includes(' (ë¸Œëœì¹˜: ')) {
                console.log('[DEBUG] íŒ¨í„´ 4 ë§¤ì¹­: ì‹¤ì œ íŒŒì¼ ë‚´ìš© í¬í•¨');
                // ì‹¤ì œ íŒŒì¼ ë‚´ìš©ì´ í¬í•¨ëœ ë©”ì‹œì§€ì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
                const fileMatches = userMessage.match(/--- (.+?) \(ë¸Œëœì¹˜: .+?\) ---/g);
                if (fileMatches) {
                    const fileNames = fileMatches.map(match => {
                        const fileName = match.match(/--- (.+?) \(ë¸Œëœì¹˜:/)[1];
                        return fileName.trim();
                    }).filter(file => file);
                    contextInfo = fileNames.join(', ');
                    
                    // ì§ˆë¬¸ ë¶€ë¶„ë§Œ ì¶”ì¶œ (ì²« ë²ˆì§¸ ì»¨í…ìŠ¤íŠ¸ ë§ˆì»¤ ì´ì „ê¹Œì§€)
                    const firstContextIndex = userMessage.indexOf('\n\n--- ');
                    if (firstContextIndex > 0) {
                        userMessage = userMessage.substring(0, firstContextIndex).trim();
                    }
                }
            }
            // íŒ¨í„´ 5: AI ì‘ë‹µì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì—­ì¶”ì  (ìƒˆë¡œìš´ ê¸°ëŠ¥)
            else {
                console.log('[DEBUG] ì§ì ‘ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ê°€ ì—†ìŒ, AI ì‘ë‹µì—ì„œ ì—­ì¶”ì  ì‹œë„');
                // í˜„ì¬ ë©”ì‹œì§€ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                const currentIndex = result.chat_history.findIndex(m => m === msg);
                // ë°”ë¡œ ë‹¤ìŒ AI ì‘ë‹µ í™•ì¸
                if (currentIndex >= 0 && currentIndex + 1 < result.chat_history.length) {
                    const nextMsg = result.chat_history[currentIndex + 1];
                    if (nextMsg.role === 'assistant') {
                        // AI ì‘ë‹µì—ì„œ íŒŒì¼ëª… íŒ¨í„´ ì°¾ê¸°
                        const filePatterns = [
                            /`([^`]+\.py)`/g,
                            /`([^`]+\.js)`/g,
                            /`([^`]+\.ts)`/g,
                            /`([^`]+\.java)`/g,
                            /`([^`]+\.cpp)`/g,
                            /`([^`]+\.c)`/g,
                            /`([^`]+\.h)`/g,
                            /íŒŒì¼.*?`([^`]+\.\w+)`/g,
                            /ë¶„ì„.*?`([^`]+\.\w+)`/g
                        ];
                        
                        let foundFiles = new Set();
                        filePatterns.forEach(pattern => {
                            let match;
                            while ((match = pattern.exec(nextMsg.content)) !== null) {
                                foundFiles.add(match[1]);
                            }
                        });
                        
                        if (foundFiles.size > 0) {
                            contextInfo = Array.from(foundFiles).join(', ');
                            console.log('[DEBUG] AI ì‘ë‹µì—ì„œ ì—­ì¶”ì í•œ ì»¨í…ìŠ¤íŠ¸:', contextInfo);
                        }
                    }
                }
            }
                            
                            console.log(`[DEBUG] ì²˜ë¦¬ëœ ì‚¬ìš©ì ë©”ì‹œì§€:`, userMessage);
                            console.log(`[DEBUG] ì¶”ì¶œëœ ì»¨í…ìŠ¤íŠ¸ ì •ë³´:`, contextInfo);
                            
                            let userMessageHtml = `<div class="msg-user flex justify-end mb-2"><div class="bg-gray-700 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-yellow-300">ë‚˜:</b> ${escapeHtml(userMessage)}`;
                            
                            if (contextInfo) {
                                userMessageHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-300"><span class="material-icons text-xs mr-1">description</span>ì„ íƒëœ íŒŒì¼: ${escapeHtml(contextInfo)}</div>`;
                            }
                            
                            userMessageHtml += `</div></div>`;
                            chatBox.innerHTML += userMessageHtml;
                        } else if (msg.role === 'assistant') {
                            // AI ì‘ë‹µ ì²˜ë¦¬ ê°œì„  - ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ try-catch ì¶”ê°€
                            try {
                                const parsedContent = marked.parse(msg.content);
                                chatBox.innerHTML += `<div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${parsedContent} </div></div>`;
                            } catch (parseError) {
                                console.error('ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì˜¤ë¥˜:', parseError);
                                // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë‚´ìš© ê·¸ëŒ€ë¡œ í‘œì‹œ
                                chatBox.innerHTML += `<div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${msg.content} </div></div>`;
                            }
                        }
                    } catch (msgError) {
                        console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', msgError, msg);
                    }
                });
            }
            
            // ì½”ë“œ ë¸”ë¡ì— ìŠ¤íƒ€ì¼ ì ìš©
            document.querySelectorAll('#chat-box pre code').forEach(block => {
                try {
                    styleCodeBlock(block);
                } catch (styleError) {
                    console.error('ì½”ë“œ ë¸”ë¡ ìŠ¤íƒ€ì¼ ì ìš© ì˜¤ë¥˜:', styleError);
                }
            });
        } else {
            // ì±„íŒ… ë‚´ì—­ì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ìœ ì§€
            console.log('í‘œì‹œí•  ì±„íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
        }
    } catch (error) {
        console.error('ì±„íŒ… ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
    }
    
    // ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ ìµœí•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // ì±„íŒ… ê¸°ë¡ ë¡œë“œ ì™„ë£Œ í›„ íŒŒì¼ íƒìƒ‰ê¸° ì´ˆê¸°í™”
    try {
        await initFileExplorer();
        console.log('[DEBUG] íŒŒì¼ íƒìƒ‰ê¸° ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('[ERROR] íŒŒì¼ íƒìƒ‰ê¸° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    }
    
    // ì„¸ì…˜ ê´€ë¦¬ ëª¨ë“œ í† ê¸€ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const editModeToggle = document.getElementById('edit-mode-toggle');
    editModeToggle.addEventListener('change', function() {
        const sessionControls = document.querySelectorAll('.session-controls');
        const chatSessionItems = document.querySelectorAll('.chat-session-item');
        
        if (this.checked) {
            // ê´€ë¦¬ ëª¨ë“œ í™œì„±í™”
            sessionControls.forEach(control => control.classList.remove('hidden'));
            chatSessionItems.forEach(item => {
                item.style.paddingRight = '130px'; // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê³µê°„ í™•ë³´
                item.classList.add('edit-mode');
            });
        } else {
            // ê´€ë¦¬ ëª¨ë“œ ë¹„í™œì„±í™”
            sessionControls.forEach(control => control.classList.add('hidden'));
            chatSessionItems.forEach(item => {
                item.style.paddingRight = '';
                item.classList.remove('edit-mode');
            });
        }
    });
    
    // ì„¸ì…˜ ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„ìœ¼ë¡œ ì²˜ë¦¬
    document.getElementById('chat-sessions-list').addEventListener('click', async function(e) {
        // ê¸°ë³¸ í´ë¦­ ë™ì‘ì€ ê´€ë¦¬ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì‘ë™
        if (!editModeToggle.checked && e.target.closest('.chat-session-item')) {
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            if (sessionId) {
                window.location.href = `/chat/${sessionId}`;
            }
            return;
        }
        
        // ì´ë¦„ ë³€ê²½ ë²„íŠ¼ ì²˜ë¦¬
        if (e.target.closest('.rename-session')) {
            e.stopPropagation(); // ìƒìœ„ ìš”ì†Œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            const nameElement = sessionItem.querySelector('.chat-session-name');
            const currentName = nameElement.textContent;
            
            const newName = prompt('ìƒˆ ì±„íŒ… ì„¸ì…˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentName);
            if (newName && newName.trim() !== '') {
                try {
                    const response = await fetch('/rename-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: sessionId, new_name: newName })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'ì„±ê³µ') {
                        nameElement.textContent = newName;
                    } else {
                        alert('ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('ì´ë¦„ ë³€ê²½ ì˜¤ë¥˜:', error);
                    alert('ì´ë¦„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ìœ„ë¡œ ì´ë™ ë²„íŠ¼ ì²˜ë¦¬
        if (e.target.closest('.move-up-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const prevItem = sessionItem.previousElementSibling;
            
            if (prevItem && prevItem.classList.contains('chat-session-item')) {
                try {
                    const sessionId = sessionItem.dataset.sessionId;
                    const prevSessionId = prevItem.dataset.sessionId;
                    
                    const response = await fetch('/reorder-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            session_id: sessionId, 
                            target_position: 'up',
                            reference_session_id: prevSessionId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'ì„±ê³µ') {
                        // DOMì—ì„œ ìˆœì„œ ë³€ê²½
                        sessionItem.parentNode.insertBefore(sessionItem, prevItem);
                    } else {
                        alert('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:', error);
                    alert('ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ ì²˜ë¦¬
        if (e.target.closest('.move-down-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const nextItem = sessionItem.nextElementSibling;
            
            if (nextItem && nextItem.classList.contains('chat-session-item')) {
                try {
                    const sessionId = sessionItem.dataset.sessionId;
                    const nextSessionId = nextItem.dataset.sessionId;
                    
                    const response = await fetch('/reorder-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            session_id: sessionId, 
                            target_position: 'down',
                            reference_session_id: nextSessionId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === 'ì„±ê³µ') {
                        // DOMì—ì„œ ìˆœì„œ ë³€ê²½
                        sessionItem.parentNode.insertBefore(nextItem, sessionItem);
                    } else {
                        alert('ìˆœì„œ ë³€ê²½ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    console.error('ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:', error);
                    alert('ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // MD ì¶”ì¶œ ë²„íŠ¼ ì²˜ë¦¬
        if (e.target.closest('.export-md-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            
            try {
                const response = await fetch('/export-chat-md', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `chat-session-${sessionId}.md`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showToast('ì±„íŒ… ë‚´ì—­ì´ MD íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    const result = await response.json();
                    alert('MD ì¶”ì¶œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('MD ì¶”ì¶œ ì˜¤ë¥˜:', error);
                alert('MD ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
        if (e.target.closest('.delete-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            const deleteButton = e.target.closest('.delete-session');
            
            if (confirm('ì´ ì±„íŒ… ì„¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²½ê³ : ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                try {
                    // ì‚­ì œ ë²„íŠ¼ ë¹„í™œì„±í™”
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">hourglass_empty</span>';
                    
                    const response = await fetch('/delete-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === 'ì„±ê³µ') {
                            showToast('ì±„íŒ… ì„¸ì…˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            
                            // í˜„ì¬ ì„¸ì…˜ì´ ì‚­ì œëœ ê²½ìš° ì²« ë²ˆì§¸ ì„¸ì…˜ìœ¼ë¡œ ì´ë™í•˜ê±°ë‚˜ í™ˆìœ¼ë¡œ ì´ë™
                            if (sessionId === '{{ session_id }}') {
                                if (result.next_session_id) {
                                    window.location.href = `/chat/${result.next_session_id}`;
                                } else {
                                    window.location.href = '/';
                                }
                            } else {
                                // ë‹¤ë¥¸ ì„¸ì…˜ì´ ì‚­ì œëœ ê²½ìš° í˜„ì¬ í˜ì´ì§€ì—ì„œ í•´ë‹¹ í•­ëª©ë§Œ ì œê±°
                                sessionItem.style.transition = 'opacity 0.3s ease-out';
                                sessionItem.style.opacity = '0';
                                setTimeout(() => {
                                    sessionItem.remove();
                                }, 300);
                            }
                        } else {
                            alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                            // ë²„íŠ¼ ë³µì›
                            deleteButton.disabled = false;
                            deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">delete</span>';
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert(`ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    // ë²„íŠ¼ ë³µì›
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">delete</span>';
                }
            }
        }
    });

    // ë¸Œëœì¹˜ ë° íŒŒì¼ íƒìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”ëŠ” ì±„íŒ… ê¸°ë¡ ë¡œë“œ í›„ì— ì‹¤í–‰
    // initFileExplorer();
});

// ì„ íƒëœ íŒŒì¼ë“¤ì„ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
let selectedFiles = [];

// íŒŒì¼ íƒìƒ‰ê¸° ì´ˆê¸°í™” í•¨ìˆ˜
async function initFileExplorer() {
    const sessionId = '{{ session_id }}';
    const branchSelector = document.getElementById('branch-selector');
    const fileTree = document.getElementById('file-tree');
    const fileTreeLoading = document.getElementById('file-tree-loading');
    const toggleButton = document.getElementById('toggle-file-explorer');
    const showButton = document.getElementById('show-file-explorer-btn');
    const fileExplorer = document.getElementById('file-explorer');
    const showFileExplorer = document.getElementById('show-file-explorer');
    
    // íŒŒì¼ íƒìƒ‰ê¸° ìˆ¨ê¸°ê¸° ê¸°ëŠ¥
    toggleButton.addEventListener('click', function() {
        fileExplorer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
        fileExplorer.style.transform = 'translateX(-100%)';
        fileExplorer.style.opacity = '0';
        
        setTimeout(() => {
            fileExplorer.style.display = 'none';
            showFileExplorer.style.display = 'flex';
            showFileExplorer.style.opacity = '0';
            showFileExplorer.style.transform = 'translateX(-20px)';
            
            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê¸°
            setTimeout(() => {
                showFileExplorer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                showFileExplorer.style.transform = 'translateX(0)';
                showFileExplorer.style.opacity = '1';
            }, 50);
        }, 300);
    });
    
    // íŒŒì¼ íƒìƒ‰ê¸° ë³´ì´ê¸° ê¸°ëŠ¥
    showButton.addEventListener('click', function() {
        showFileExplorer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
        showFileExplorer.style.transform = 'translateX(-20px)';
        showFileExplorer.style.opacity = '0';
        
        setTimeout(() => {
            showFileExplorer.style.display = 'none';
            fileExplorer.style.display = 'flex';
            fileExplorer.style.opacity = '0';
            fileExplorer.style.transform = 'translateX(-100%)';
            
            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ê¸°
            setTimeout(() => {
                fileExplorer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                fileExplorer.style.transform = 'translateX(0)';
                fileExplorer.style.opacity = '1';
            }, 50);
        }, 300);
    });
    
    // ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
    initSelectedFilesContext();
    
    // ì±„íŒ… ê¸°ë¡ ì •ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById('cleanup-context-btn').addEventListener('click', async function() {
        if (confirm('ì±„íŒ… ê¸°ë¡ì—ì„œ ë¶ˆí•„ìš”í•œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ ì •ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹¤ì œë¡œ íŒŒì¼ì„ ì„ íƒí•œ ì§ˆë¬¸ë§Œ ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ì§€ë©ë‹ˆë‹¤)')) {
            try {
                this.disabled = true;
                this.innerHTML = '<span class="material-icons text-sm mr-1">hourglass_empty</span>ì •ë¦¬ ì¤‘...';
                
                const response = await fetch('/cleanup-chat-context', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id: '{{ session_id }}' })
                });
                
                const result = await response.json();
                if (result.status === 'ì„±ê³µ') {
                    showToast(`ì±„íŒ… ê¸°ë¡ ì •ë¦¬ ì™„ë£Œ: ${result.updated_count}ê°œ ë©”ì‹œì§€ ì •ë¦¬ë¨`);
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì •ë¦¬ëœ ì±„íŒ… ê¸°ë¡ í‘œì‹œ
                    window.location.reload();
                } else {
                    alert('ì •ë¦¬ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì±„íŒ… ê¸°ë¡ ì •ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                this.disabled = false;
                this.innerHTML = '<span class="material-icons text-sm mr-1">cleaning_services</span>ì±„íŒ… ê¸°ë¡ ì •ë¦¬';
            }
        }
    });
    
    // ë¸Œëœì¹˜ ëª©ë¡ ë¡œë“œ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
    async function loadBranches(retryCount = 0) {
        const maxRetries = 3;
        try {
            console.log(`[DEBUG] ë¸Œëœì¹˜ ë¡œë“œ ì‹œë„ ${retryCount + 1}/${maxRetries + 1}`);
            branchSelector.innerHTML = '<option value="">ë¸Œëœì¹˜ ë¡œë”© ì¤‘...</option>';
            
            const response = await fetch(`/api/branches/${sessionId}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                console.log(`[DEBUG] ë¸Œëœì¹˜ ë¡œë“œ ì„±ê³µ: ${result.branches.length}ê°œ ë¸Œëœì¹˜`);
                branchSelector.innerHTML = '<option value="">ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”...</option>';
                result.branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchSelector.appendChild(option);
                });
                
                // ê¸°ë³¸ ë¸Œëœì¹˜ ì„ íƒ (main ë˜ëŠ” master)
                const defaultBranch = result.branches.find(b => b.name === 'main') || 
                                    result.branches.find(b => b.name === 'master') || 
                                    result.branches[0];
                if (defaultBranch) {
                    branchSelector.value = defaultBranch.name;
                    await loadFileTree(sessionId, defaultBranch.name);
                }
            } else {
                throw new Error(result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            }
        } catch (error) {
            console.error(`[ERROR] ë¸Œëœì¹˜ ë¡œë“œ ì‹¤íŒ¨ (ì‹œë„ ${retryCount + 1}):`, error);
            
            if (retryCount < maxRetries) {
                // ì¬ì‹œë„ ì „ ì ì‹œ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                return loadBranches(retryCount + 1);
            } else {
                // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                branchSelector.innerHTML = '<option value="">ë¸Œëœì¹˜ ë¡œë“œ ì‹¤íŒ¨ (ì¬ì‹œë„ ì´ˆê³¼)</option>';
                console.error('[ERROR] ë¸Œëœì¹˜ ë¡œë“œ ìµœì¢… ì‹¤íŒ¨');
            }
        }
    }
    
    await loadBranches();
    
    // ë¸Œëœì¹˜ ì„ íƒ ì´ë²¤íŠ¸
    branchSelector.addEventListener('change', function() {
        const selectedBranch = this.value;
        if (selectedBranch) {
            loadFileTree(sessionId, selectedBranch);
        } else {
            fileTree.innerHTML = '<div class="text-xs text-gray-500 italic p-2">ë¸Œëœì¹˜ë¥¼ ì„ íƒí•˜ë©´ íŒŒì¼ êµ¬ì¡°ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>';
        }
    });
}

// íŒŒì¼ íŠ¸ë¦¬ ë¡œë“œ í•¨ìˆ˜
async function loadFileTree(sessionId, branchName) {
    const fileTree = document.getElementById('file-tree');
    const fileTreeLoading = document.getElementById('file-tree-loading');
    
    fileTreeLoading.classList.remove('hidden');
    fileTree.innerHTML = '';
    
    try {
        const response = await fetch(`/api/files/${sessionId}/${branchName}`);
        const result = await response.json();
        
        if (result.success) {
            const treeStructure = buildFileTree(result.files, result.directories);
            fileTree.innerHTML = treeStructure;
            
            // íŒŒì¼ í´ë¦­ ë° ìš°í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            fileTree.addEventListener('click', function(e) {
                if (e.target.closest('.file-item')) {
                    const fileItem = e.target.closest('.file-item');
                    const filePath = fileItem.dataset.path;
                    showFileContent(sessionId, branchName, filePath);
                }
            });
            
            // íŒŒì¼ ìš°í´ë¦­ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ë²¤íŠ¸
            fileTree.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.file-item')) {
                    e.preventDefault();
                    const fileItem = e.target.closest('.file-item');
                    const filePath = fileItem.dataset.path;
                    addFileToContext(sessionId, branchName, filePath);
                }
            });
        } else {
            fileTree.innerHTML = `<div class="text-xs text-red-400 p-2">íŒŒì¼ êµ¬ì¡° ë¡œë“œ ì‹¤íŒ¨: ${result.error}</div>`;
        }
    } catch (error) {
        console.error('íŒŒì¼ íŠ¸ë¦¬ ë¡œë“œ ì˜¤ë¥˜:', error);
        fileTree.innerHTML = '<div class="text-xs text-red-400 p-2">íŒŒì¼ êµ¬ì¡° ë¡œë“œ ì˜¤ë¥˜</div>';
    } finally {
        fileTreeLoading.classList.add('hidden');
    }
}

// íŒŒì¼ íŠ¸ë¦¬ êµ¬ì¡° ìƒì„± í•¨ìˆ˜
function buildFileTree(files, directories) {
    const tree = {};
    
    // ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„±
    directories.forEach(dir => {
        const parts = dir.path.split('/');
        let current = tree;
        parts.forEach(part => {
            if (!current[part]) {
                current[part] = { type: 'directory', children: {} };
            }
            current = current[part].children;
        });
    });
    
    // íŒŒì¼ ì¶”ê°€
    files.forEach(file => {
        const parts = file.path.split('/');
        const fileName = parts.pop();
        let current = tree;
        
        // ë””ë ‰í† ë¦¬ ê²½ë¡œ ìƒì„±
        parts.forEach(part => {
            if (!current[part]) {
                current[part] = { type: 'directory', children: {} };
            }
            current = current[part].children;
        });
        
        // íŒŒì¼ ì¶”ê°€
        current[fileName] = { type: 'file', path: file.path, size: file.size };
    });
    
    return renderTree(tree);
}

// íŠ¸ë¦¬ ë Œë”ë§ í•¨ìˆ˜
function renderTree(tree, level = 0) {
    let html = '';
    const indent = '  '.repeat(level);
    
    Object.keys(tree).sort((a, b) => {
        // ë””ë ‰í† ë¦¬ë¥¼ ë¨¼ì €, ê·¸ ë‹¤ìŒ íŒŒì¼
        const aIsDir = tree[a].type === 'directory';
        const bIsDir = tree[b].type === 'directory';
        if (aIsDir && !bIsDir) return -1;
        if (!aIsDir && bIsDir) return 1;
        return a.localeCompare(b);
    }).forEach(name => {
        const item = tree[name];
        
        if (item.type === 'directory') {
            html += `
                <div class="directory-item" style="margin-left: ${level * 12}px;">
                    <div class="flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer text-xs" onclick="toggleDirectory(this)">
                        <span class="material-icons text-xs mr-1">folder</span>
                        <span class="text-blue-300">${name}</span>
                        <span class="material-icons text-xs ml-auto">expand_more</span>
</div>
                    <div class="directory-content hidden">
                        ${renderTree(item.children, level + 1)}
</div>
                </div>
            `;
        } else {
            const fileIcon = getFileIcon(name);
            const fileSize = formatFileSize(item.size);
            html += `
                <div class="file-item flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer text-xs" 
                     style="margin-left: ${level * 12}px;" data-path="${item.path}">
                    <span class="material-icons text-xs mr-1">${fileIcon}</span>
                    <span class="text-gray-300 flex-1">${name}</span>
                    <span class="text-gray-500 text-xs ml-2">${fileSize}</span>
                </div>
            `;
        }
    });
    
    return html;
}

// ë””ë ‰í† ë¦¬ í† ê¸€ í•¨ìˆ˜
function toggleDirectory(element) {
    const content = element.nextElementSibling;
    const icon = element.querySelector('.material-icons:last-child');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = 'expand_less';
    } else {
        content.classList.add('hidden');
        icon.textContent = 'expand_more';
    }
}

// íŒŒì¼ ì•„ì´ì½˜ ë°˜í™˜ í•¨ìˆ˜
function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const iconMap = {
        'py': 'code',
        'js': 'code',
        'ts': 'code',
        'html': 'web',
        'css': 'style',
        'md': 'description',
        'txt': 'description',
        'json': 'data_object',
        'yml': 'settings',
        'yaml': 'settings',
        'xml': 'code',
        'sql': 'storage',
        'sh': 'terminal',
        'bat': 'terminal',
        'dockerfile': 'docker',
        'gitignore': 'visibility_off',
        'readme': 'info'
    };
    
    return iconMap[ext] || 'insert_drive_file';
}

// íŒŒì¼ í¬ê¸° í¬ë§· í•¨ìˆ˜
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// í˜„ì¬ í‘œì‹œ ì¤‘ì¸ íŒŒì¼ ì •ë³´ ì €ì¥
let currentFileInfo = null;

// íŒŒì¼ ë‚´ìš© í‘œì‹œ í•¨ìˆ˜
async function showFileContent(sessionId, branchName, filePath) {
    const codePreview = document.getElementById('code-preview');
    const codePreviewContent = document.getElementById('code-preview-content');
    const previewTitle = codePreview.querySelector('h3');
    
    // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ í‘œì‹œ
    codePreview.style.display = 'block';
    previewTitle.textContent = filePath;
    codePreviewContent.innerHTML = '<div class="text-gray-400">íŒŒì¼ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    
    try {
        const response = await fetch(`/api/file-content/${sessionId}/${branchName}/${encodeURIComponent(filePath)}`);
        const result = await response.json();
        
        if (result.success) {
            const language = getLanguageFromPath(filePath);
            const escapedContent = escapeHtml(result.content);
            
            // í˜„ì¬ íŒŒì¼ ì •ë³´ ì €ì¥
            currentFileInfo = {
                sessionId,
                branchName,
                filePath,
                content: result.content,
                language
            };
            
            codePreviewContent.innerHTML = `
                <pre><code class="language-${language}">${escapedContent}</code></pre>
            `;
            
            // ì½”ë“œ í•˜ì´ë¼ì´íŒ… ì ìš©
            const codeBlock = codePreviewContent.querySelector('code');
            if (codeBlock) {
                hljs.highlightElement(codeBlock);
            }
        } else {
            codePreviewContent.innerHTML = `<div class="text-red-400">íŒŒì¼ ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨: ${result.error}</div>`;
            currentFileInfo = null;
        }
    } catch (error) {
        console.error('íŒŒì¼ ë‚´ìš© ë¡œë“œ ì˜¤ë¥˜:', error);
        codePreviewContent.innerHTML = '<div class="text-red-400">íŒŒì¼ ë‚´ìš© ë¡œë“œ ì˜¤ë¥˜</div>';
        currentFileInfo = null;
    }
}

// íŒŒì¼ ê²½ë¡œì—ì„œ ì–¸ì–´ ì¶”ì¶œ í•¨ìˆ˜
function getLanguageFromPath(filePath) {
    const ext = filePath.split('.').pop().toLowerCase();
    const languageMap = {
        'py': 'python',
        'js': 'javascript',
        'ts': 'typescript',
        'html': 'html',
        'css': 'css',
        'md': 'markdown',
        'json': 'json',
        'yml': 'yaml',
        'yaml': 'yaml',
        'xml': 'xml',
        'sql': 'sql',
        'sh': 'bash',
        'bat': 'batch'
    };
    
    return languageMap[ext] || 'text';
}

// ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° ê´€ë ¨ ì´ë²¤íŠ¸ë“¤
document.getElementById('close-preview').addEventListener('click', function() {
    document.getElementById('code-preview').style.display = 'none';
});

document.getElementById('fullscreen-preview').addEventListener('click', function() {
    if (currentFileInfo) {
        showFullscreenModal(currentFileInfo);
    }
});

document.getElementById('close-fullscreen').addEventListener('click', function() {
    document.getElementById('fullscreen-modal').classList.add('hidden');
});

document.getElementById('add-to-context-btn').addEventListener('click', function() {
    if (currentFileInfo) {
        addFileToContextFromModal(currentFileInfo);
    }
});

// ì „ì²´ í™”ë©´ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showFullscreenModal(fileInfo) {
    const modal = document.getElementById('fullscreen-modal');
    const title = document.getElementById('fullscreen-title');
    const content = document.getElementById('fullscreen-content');
    
    title.textContent = fileInfo.filePath;
    
    const escapedContent = escapeHtml(fileInfo.content);
    content.innerHTML = `
        <pre><code class="language-${fileInfo.language}">${escapedContent}</code></pre>
    `;
    
    // ì½”ë“œ í•˜ì´ë¼ì´íŒ… ì ìš©
    const codeBlock = content.querySelector('code');
    if (codeBlock) {
        hljs.highlightElement(codeBlock);
    }
    
    modal.classList.remove('hidden');
}

// ëª¨ë‹¬ì—ì„œ ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function addFileToContextFromModal(fileInfo) {
    // ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì¸ì§€ í™•ì¸
    const existingFile = selectedFiles.find(f => f.path === fileInfo.filePath);
    if (existingFile) {
        showToast('ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì…ë‹ˆë‹¤.');
        return;
    }
    
    selectedFiles.push({
        path: fileInfo.filePath,
        content: fileInfo.content,
        branch: fileInfo.branchName
    });
    updateSelectedFilesDisplay();
    
    // ì„±ê³µ ë©”ì‹œì§€
    showToast(`íŒŒì¼ "${fileInfo.filePath}"ì´(ê°€) ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    
    // ëª¨ë‹¬ ë‹«ê¸°
    document.getElementById('fullscreen-modal').classList.add('hidden');
}

// ì„ íƒëœ íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function initSelectedFilesContext() {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì´ì „ ì„ íƒ ìƒíƒœ ë³µì›
    const sessionId = '{{ session_id }}';
    const savedContext = localStorage.getItem(`selectedFiles_${sessionId}`);
    
    if (savedContext) {
        try {
            selectedFiles = JSON.parse(savedContext);
            console.log('[DEBUG] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë³µì›:', selectedFiles);
        } catch (e) {
            console.error('[ERROR] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì»¨í…ìŠ¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨:', e);
            selectedFiles = [];
        }
    } else {
        selectedFiles = [];
    }
    
    updateSelectedFilesDisplay();
    
    const clearButton = document.getElementById('clear-selected-files');
    const mdFileUpload = document.getElementById('md-file-upload');
    
    clearButton.addEventListener('click', function() {
        selectedFiles = [];
        updateSelectedFilesDisplay();
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œë„ ì œê±°
        localStorage.removeItem(`selectedFiles_${sessionId}`);
    });
    
    // MD íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
    mdFileUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleMdFileUpload(file);
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            e.target.value = '';
        }
    });
}

// MD íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ í•¨ìˆ˜
function handleMdFileUpload(file) {
    // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
    if (file.size > 5 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    // íŒŒì¼ í™•ì¥ì ì²´í¬
    const allowedExtensions = ['.md', '.txt'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    if (!allowedExtensions.includes(fileExtension)) {
        alert('MD ë˜ëŠ” TXT íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        
        // ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
        const existingFile = selectedFiles.find(f => f.path === file.name);
        if (existingFile) {
            if (!confirm('ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì´ë¯¸ ìˆìŠµë‹ˆë‹¤. êµì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            // ê¸°ì¡´ íŒŒì¼ ì œê±°
            selectedFiles = selectedFiles.filter(f => f.path !== file.name);
        }
        
        // íŒŒì¼ì„ ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€
        selectedFiles.push({
            path: file.name,
            content: content,
            branch: 'uploaded',
            type: 'uploaded'
        });
        
        updateSelectedFilesDisplay();
        showToast(`íŒŒì¼ "${file.name}"ì´(ê°€) ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };
    
    reader.onerror = function() {
        alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    };
    
    reader.readAsText(file, 'UTF-8');
}

function addFileToContext(sessionId, branchName, filePath) {
    // ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì¸ì§€ í™•ì¸
    const existingFile = selectedFiles.find(f => f.path === filePath);
    if (existingFile) {
        alert('ì´ë¯¸ ì„ íƒëœ íŒŒì¼ì…ë‹ˆë‹¤.');
        return;
    }
    
    // íŒŒì¼ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
    fetch(`/api/file-content/${sessionId}/${branchName}/${encodeURIComponent(filePath)}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                selectedFiles.push({
                    path: filePath,
                    content: result.content,
                    branch: branchName
                });
                updateSelectedFilesDisplay();
                
                // ì„±ê³µ ë©”ì‹œì§€
                showToast(`íŒŒì¼ "${filePath}"ì´(ê°€) ì»¨í…ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                alert(`íŒŒì¼ ë‚´ìš©ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${result.error}`);
            }
        })
        .catch(error => {
            console.error('íŒŒì¼ ë‚´ìš© ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('íŒŒì¼ ë‚´ìš© ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
}

function updateSelectedFilesDisplay() {
    const filesList = document.getElementById('selected-files-list');
    const clearButton = document.getElementById('clear-selected-files');
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— í˜„ì¬ ìƒíƒœ ì €ì¥
    const sessionId = '{{ session_id }}';
    if (selectedFiles.length > 0) {
        localStorage.setItem(`selectedFiles_${sessionId}`, JSON.stringify(selectedFiles));
    } else {
        localStorage.removeItem(`selectedFiles_${sessionId}`);
    }
    
    if (selectedFiles.length === 0) {
        filesList.style.display = 'none';
        clearButton.style.display = 'none';
        return;
    }
    
    filesList.style.display = 'flex';
    clearButton.style.display = 'block';
    filesList.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const fileTag = document.createElement('div');
        const isUploaded = file.type === 'uploaded';
        const bgColor = isUploaded ? 'bg-purple-600' : 'bg-blue-600';
        const hoverColor = isUploaded ? 'hover:bg-purple-700' : 'hover:bg-blue-700';
        const icon = isUploaded ? 'upload_file' : 'description';
        
        fileTag.className = `${bgColor} text-white px-3 py-1 rounded-full text-xs flex items-center`;
        fileTag.innerHTML = `
            <span class="material-icons text-xs mr-1">${icon}</span>
            <span>${file.path}</span>
            ${isUploaded ? '<span class="text-xs ml-1 opacity-75">(ì—…ë¡œë“œë¨)</span>' : ''}
            <button class="ml-2 ${hoverColor} rounded-full p-1" onclick="removeFileFromContext(${index})">
                <span class="material-icons text-xs">close</span>
            </button>
        `;
        filesList.appendChild(fileTag);
    });
}

function removeFileFromContext(index) {
    selectedFiles.splice(index, 1);
    updateSelectedFilesDisplay();
}

function showToast(message) {
    // ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
</body>
</html>
