<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>GitHub AI 코드 분석</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            scrollbar-width: thin;
            scrollbar-color: #4b5563 #1f2937;
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track { 
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
            background-color: #1a202c !important;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
        
        /* 채팅 메시지 스타일 개선 */
        .msg-ai, .msg-user {
            display: flex;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .msg-ai {
            justify-content: flex-start;
        }
        
        .msg-user {
            justify-content: flex-end;
        }
        
        .msg-ai > div {
            background-color: #2d3748;
            color: #f3f4f6; /* Added for better text readability */
            border-radius: 12px 12px 12px 0;
            max-width: 85%;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        /* Enhanced readability for AI messages */
        .msg-ai > div p {
            margin-bottom: 0.8rem; /* Space between paragraphs */
            line-height: 1.65;    /* Space between lines within a paragraph */
        }
        .msg-ai > div ul, .msg-ai > div ol {
            margin-left: 1.5rem;  /* Indentation for lists */
            margin-bottom: 0.8rem;/* Space after lists */
            list-style-position: outside; /* Ensure bullets/numbers are outside the text flow */
        }
        .msg-ai > div ul {
            list-style-type: disc; /* Default bullet for unordered lists */
        }
        .msg-ai > div ol {
            list-style-type: decimal; /* Default numbering for ordered lists */
        }
        .msg-ai > div li {
            margin-bottom: 0.3rem; /* Space between list items */
        }
        .msg-ai > div strong, .msg-ai > div b { /* Make bold text slightly more prominent */
            color: #ffffff; 
            font-weight: 600;
        }
        .msg-ai > div em, .msg-ai > div i { /* Style for italic text */
            color: #e2e8f0; 
            font-style: italic;
        }

        .msg-user > div {
            background-color: #3b4a63;
            border-radius: 12px 12px 0 12px;
            max-width: 85%;
            padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .msg-ai > div, .msg-user > div {
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        /* 코드 블록 가독성 개선 스타일 */
        .hljs {
            font-size: 14px;
            line-height: 1.5;
            padding: 1rem;
            border-radius: 8px;
            background-color: #1a202c !important;
            border: 1px solid #374151;
        }
        
        /* 한글 주석 가독성 개선 */
        .hljs-comment {
            color: #8bbe9a !important;
            font-style: italic;
        }
        
        /* 로딩 애니메이션 스타일 */
        .loading-wrapper {
          width: 80px;
          height: 30px;
          position: relative;
          z-index: 1;
          display: inline-block;
          margin-left: 5px;
        }

        .loading-circle {
          width: 8px;
          height: 8px;
          position: absolute;
          border-radius: 50%;
          background-color: #8b9cb3;
          left: 15%;
          transform-origin: 50%;
          animation: circle7124 .5s alternate infinite ease;
        }

        @keyframes circle7124 {
          0% {
            top: 30px;
            height: 3px;
            border-radius: 50px 50px 25px 25px;
            transform: scaleX(1.7);
          }

          40% {
            height: 20px;
            border-radius: 50%;
            transform: scaleX(1);
          }

          100% {
            top: 0%;
          }
        }

        .loading-circle:nth-child(2) {
          left: 45%;
          animation-delay: .2s;
        }

        .loading-circle:nth-child(3) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }

        .loading-shadow {
          width: 8px;
          height: 2px;
          border-radius: 50%;
          background-color: rgba(0,0,0,0.5);
          position: absolute;
          top: 32px;
          transform-origin: 50%;
          z-index: -1;
          left: 15%;
          filter: blur(1px);
          animation: shadow046 .5s alternate infinite ease;
        }

        @keyframes shadow046 {
          0% {
            transform: scaleX(1.5);
          }

          40% {
            transform: scaleX(1);
            opacity: .7;
          }

          100% {
            transform: scaleX(.2);
            opacity: .4;
          }
        }

        .loading-shadow:nth-child(4) {
          left: 45%;
          animation-delay: .2s
        }

        .loading-shadow:nth-child(5) {
          left: auto;
          right: 15%;
          animation-delay: .3s;
        }
        
        /* GitHub 푸시 버튼 스타일 */
        .github-push-btn {
            display: inline-flex;
            align-items: center;
            background-color: #238636;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 8px;
        }
        
        .github-push-btn:hover {
            background-color: #2ea043;
        }
        
        .github-push-btn:active {
            background-color: #238636;
        }
        
        /* 코드 수정 창 스타일 */
        .code-edit-container {
            background-color: #1a202c;
            border: 1px solid #374151;
            border-radius: 8px;
            margin-top: 16px;
            overflow: hidden;
        }
        
        .code-edit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #2d3748;
            border-bottom: 1px solid #374151;
        }
        
        .code-edit-content {
            padding: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* 파일 탐색기 토글 애니메이션 */
        #file-explorer {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        #show-file-explorer {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        
        #show-file-explorer-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* 파일 탐색기 숨김 상태 개선 */
        #show-file-explorer .material-icons {
            font-size: 20px;
        }
        
        /* 세로 텍스트 스타일 개선 */
        .writing-mode-vertical {
            line-height: 1.2;
        }
        
        .writing-mode-vertical div {
            margin-bottom: 2px;
            font-weight: 500;
        }


    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-300 min-h-screen">
<div class="flex flex-col min-h-screen">
<!-- 상단 헤더 -->
<header class="bg-gray-800 p-3 flex items-center justify-between border-b border-gray-700" style="height: 70px;">
  <div class="flex items-center">
    <img src="/static/logo.jpg" alt="logo" class="h-36 w-36 object-contain mr-3" />
    <h1 class="text-white font-semibold text-xl"></h1>
  </div>
  <div class="flex items-center">
    <div id="repo-status" class="text-blue-300 mr-4 text-sm">저장소 분석이 완료되었습니다. 질문해주세요!</div>
    <img alt="User avatar" class="w-8 h-8 rounded-full" src="https://lh3.googleusercontent.com/aida-public/AB6AXuC8ljbNzHJUH9ZC9WD5AFSxwpOS3_ZcKoBsLH4ppNnwv7l3PC3qZkbjVVuRXDv_LB2aLAVzFpGwFvpgU939wCp2HDeAroJdPNVKcOjo-5whV-vaimG-X5ivF_RqhmCDcnM2Bi5WXW47zGRSkP87NchAS8fDloSnEPGY0npOYffb2D5qh2IzUJZUTY6fiJmDe041cG7cQk4McvdpSkgvIh0XcwZREUgolNXnwo0yjX29hajqa2PMtaJeo8ic779fqzftRvUOJJdkRck"/>
  </div>
</header>

<!-- 메인 컨텐츠 영역 - 네비게이터와 채팅 영역으로 분리 -->
<div class="flex flex-1">
  <!-- 왼쪽 채팅 네비게이터 -->
  <div class="bg-gray-800 w-64 border-r border-gray-700 flex-shrink-0 flex flex-col">
    <div class="p-3 flex justify-between items-center border-b border-gray-700">
      <div class="text-lg font-semibold text-white">채팅 목록</div>
      <div class="flex">
        <button id="new-chat-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200 flex items-center">
          <span class="material-icons text-sm mr-1">add</span>새 채팅
        </button>
        <a href="/" class="ml-2 bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-md text-sm transition-colors duration-200 flex items-center" title="다른 레포지토리 분석">
          <span class="material-icons text-sm mr-1">home</span>홈
        </a>
      </div>
    </div>
    
    <!-- 세션 관리 모드 토글 버튼 -->
    <div class="p-2 flex justify-between items-center border-b border-gray-700">
      <div class="text-sm text-gray-300">세션 관리</div>
      <label class="inline-flex items-center cursor-pointer">
        <input type="checkbox" id="edit-mode-toggle" class="sr-only peer">
        <div class="relative w-9 h-5 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
      </label>
    </div>
    
    <!-- 세션 목록 -->
    <div id="chat-sessions-list" class="flex-1 overflow-y-auto p-2">
      {% if chat_sessions %}
        {% for chat_session in chat_sessions %}
          <div class="chat-session-item p-2 rounded-md cursor-pointer hover:bg-gray-700 transition-colors duration-150 mb-1 relative {% if chat_session.session_id == session_id %}bg-gray-700{% endif %}" data-session-id="{{ chat_session.session_id }}">
            <div class="flex justify-between items-center">
              <div class="text-sm font-medium truncate chat-session-name">채팅 #{{ loop.index }}</div>
              <div class="text-xs text-gray-400">{{ chat_session.created_at.strftime('%Y-%m-%d') }}</div>
            </div>
            <div class="text-xs text-gray-400 mt-1">
              메시지: {{ chat_session.message_count if chat_session.message_count is not none else 0 }}개
            </div>
            
            <!-- 세션 관리 버튼 (기본적으로 숨김) -->
            <div class="session-controls absolute right-1 top-1 hidden">
              <button class="rename-session text-xs bg-blue-600 hover:bg-blue-700 text-white p-1 rounded" title="이름 변경">
                <span class="material-icons" style="font-size: 14px;">edit</span>
              </button>
              <button class="move-up-session text-xs bg-gray-600 hover:bg-gray-700 text-white p-1 rounded" title="위로 이동">
                <span class="material-icons" style="font-size: 14px;">arrow_upward</span>
              </button>
              <button class="move-down-session text-xs bg-gray-600 hover:bg-gray-700 text-white p-1 rounded" title="아래로 이동">
                <span class="material-icons" style="font-size: 14px;">arrow_downward</span>
              </button>
              <button class="export-md-session text-xs bg-green-600 hover:bg-green-700 text-white p-1 rounded" title="MD 파일로 추출">
                <span class="material-icons" style="font-size: 14px;">download</span>
              </button>
              <button class="delete-session text-xs bg-red-600 hover:bg-red-700 text-white p-1 rounded" title="삭제">
                <span class="material-icons" style="font-size: 14px;">delete</span>
              </button>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-sm text-gray-500 italic p-2">채팅 기록이 없습니다</div>
      {% endif %}
    </div>
    
    <!-- 현재 저장소 정보 -->
    <div class="p-3 bg-gray-700 border-t border-gray-600">
      <div class="text-xs text-gray-400 mb-1">현재 저장소:</div>
      <div class="text-sm font-medium truncate" title="{{ repo_url }}">{{ repo_url }}</div>
    </div>
  </div>

      <!-- 중간 파일 탐색 사이드바 -->
  <div id="file-explorer" class="bg-gray-800 w-80 border-r border-gray-700 flex-shrink-0 flex flex-col">
    <!-- 세션 관리 도구 -->
    <div class="p-3 border-b border-gray-700">
      <div class="text-sm font-semibold text-white mb-2">세션 관리</div>
      <button id="cleanup-context-btn" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-1 px-3 rounded text-sm mb-2">
        <span class="material-icons text-sm mr-1">cleaning_services</span>채팅 기록 정리
      </button>
    </div>
    
    <!-- 브랜치 선택 -->
    <div class="p-3 border-b border-gray-700">
      <div class="text-sm font-semibold text-white mb-2">브랜치 선택</div>
      <select id="branch-selector" class="w-full bg-gray-700 border border-gray-600 text-gray-200 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <option value="">브랜치를 선택하세요...</option>
      </select>
    </div>
    
    <!-- 파일 트리 -->
    <div class="flex-1 overflow-y-auto">
      <div class="p-3 border-b border-gray-700">
        <div class="text-sm font-semibold text-white mb-2">파일 구조</div>
        <div id="file-tree-loading" class="text-xs text-gray-400 hidden">파일 구조를 불러오는 중...</div>
      </div>
      <div id="file-tree" class="p-2">
        <div class="text-xs text-gray-500 italic p-2">브랜치를 선택하면 파일 구조가 표시됩니다</div>
      </div>
    </div>
    
    <!-- 파일 탐색기 토글 버튼 -->
    <div class="p-2 border-t border-gray-700">
      <button id="toggle-file-explorer" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-md text-sm transition-colors duration-200">
        <span class="material-icons text-sm mr-1">visibility_off</span>파일 탐색기 숨기기
      </button>
    </div>
  </div>

  <!-- 파일 탐색기 토글 버튼 (숨겨진 상태에서 보이는 버튼) -->
  <div id="show-file-explorer" class="bg-gray-800 border-r border-gray-600 w-16 flex-shrink-0 flex flex-col items-center justify-center py-4" style="display: none;">
    <button id="show-file-explorer-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-lg transition-all duration-200 shadow-lg mb-3" title="파일 탐색기 보이기">
      <span class="material-icons text-lg">folder_open</span>
    </button>
    <div class="text-xs text-gray-400 writing-mode-vertical text-center">
      <div>파</div>
      <div>일</div>
      <div>탐</div>
      <div>색</div>
      <div>기</div>
    </div>
  </div>

  <!-- 오른쪽 메인 채팅 영역 -->
  <div class="flex-1 flex flex-col">
    <!-- MD 파일 업로드 영역 (항상 표시) -->
    <div class="bg-gray-700 border-b border-gray-600 p-3">
      <div class="flex justify-between items-center">
        <div class="text-sm font-semibold text-white">질문 컨텍스트</div>
        <div class="flex gap-2">
          <label for="md-file-upload" class="bg-purple-600 hover:bg-purple-700 text-white px-2 py-1 rounded text-xs cursor-pointer flex items-center">
            <span class="material-icons text-xs mr-1">upload_file</span>MD 추가
          </label>
          <input type="file" id="md-file-upload" accept=".md,.txt" style="display: none;">
          <button id="clear-selected-files" class="text-gray-400 hover:text-white text-sm" style="display: none;">
            <span class="material-icons text-sm">clear_all</span> 모두 제거
          </button>
        </div>
      </div>
      <div id="selected-files-list" class="flex flex-wrap gap-2 mt-2" style="display: none;"></div>
    </div>

  <!-- 채팅 메시지 표시 영역 -->
  <div id="chat-box" class="flex-1 p-6 overflow-y-auto bg-gray-900" style="min-height:calc(100vh - 150px);">
    <!-- 채팅 메시지가 여기에 표시됩니다 -->
    <div class="msg-ai mb-6">
      <div>
        <p>안녕하세요! GitHub 저장소의 코드에 대해 질문하거나 코드 수정을 요청해보세요. 언제든지 도와드리겠습니다! 파일 구조, 함수의 목적, 버그 해결 방법 등 어떤 질문이든 가능합니다.</p>
          <p class="mt-2 text-sm text-gray-400">💡 왼쪽 파일 탐색기에서 브랜치를 선택하고 파일을 클릭하여 내용을 확인할 수 있습니다.</p>
          <p class="mt-2 text-sm text-blue-400">🔍 파일을 우클릭하여 질문 컨텍스트에 추가할 수 있습니다.</p>
      </div>
    </div>
  </div>
  
  <!-- 코드 미리보기 영역 -->
  <div id="code-preview" class="bg-gray-800 border-t border-gray-700 p-4 overflow-y-auto" style="max-height:40vh; display:none;">
    <div class="flex justify-between items-center mb-2">
      <h3 class="text-white font-medium"></h3>
        <div class="flex gap-2">
          <button id="fullscreen-preview" class="text-gray-400 hover:text-white" title="전체 화면으로 보기">
            <span class="material-icons">fullscreen</span>
          </button>
      <button id="close-preview" class="text-gray-400 hover:text-white">
        <span class="material-icons">close</span>
      </button>
        </div>
    </div>
    <div id="code-preview-content"></div>
    </div>
  </div>
</div>

<!-- 전체 화면 코드 뷰어 모달 -->
<div id="fullscreen-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden">
  <div class="flex flex-col h-full">
    <div class="bg-gray-800 p-4 flex justify-between items-center border-b border-gray-600">
      <h2 id="fullscreen-title" class="text-white font-medium text-lg"></h2>
      <div class="flex gap-2">
        <button id="add-to-context-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
          <span class="material-icons text-sm mr-1">add</span>컨텍스트에 추가
        </button>
        <button id="close-fullscreen" class="text-gray-400 hover:text-white">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>
    <div id="fullscreen-content" class="flex-1 overflow-auto bg-gray-900 p-4"></div>
  </div>
  </div>
  
  <!-- 입력 폼 영역 -->
  <div class="bg-gray-800 border-t border-gray-700 p-4">
    <form id="chat-form" class="flex gap-2">
      <input type="text" class="flex-1 bg-gray-700 border border-gray-600 text-gray-200 rounded-md py-3 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500" id="user-input" placeholder="질문 또는 코드 수정 요청 입력..." autocomplete="off" required>
      <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-md transition-all duration-200">전송</button>
    </form>
  </div>
  </div>
</div>
</div>

<script>
const chatBox = document.getElementById('chat-box');
const codePreview = document.getElementById('code-preview'); // This might be unused now
let lastFileName = '';
let lastModifiedCode = '';

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function styleCodeBlock(el) {
    if (!el.classList.contains('hljs')) {
        hljs.highlightElement(el);
    }

    el.style.backgroundColor = '#1e1e1e'; 
    el.style.color = '#ffffff';
    el.style.padding = '1rem'; // Consistent padding for code content
    el.style.fontSize = '14px';
    el.style.lineHeight = '1.6';
    el.style.border = '1px solid #333';
    el.style.borderRadius = '6px';
    el.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.3)';
    el.style.whiteSpace = 'pre-wrap'; // Ensure wrapping
    el.style.wordBreak = 'break-all'; // Ensure long words break

    const parentPre = el.parentElement;
    if (parentPre && parentPre.tagName === 'PRE') {
        parentPre.style.backgroundColor = '#1a202c'; 
        parentPre.style.padding = '0'; // Padding is now on the <code> element
        parentPre.style.borderRadius = '8px';
        parentPre.style.margin = '0.5rem 0';
        parentPre.classList.add('overflow-auto', 'max-h-96'); // For scrollability and max height
        parentPre.style.position = 'relative'; // For copy button positioning
    }

    const keywords = el.querySelectorAll('.hljs-keyword, .hljs-selector-tag, .hljs-built_in, .hljs-tag');
    const strings = el.querySelectorAll('.hljs-string, .hljs-regexp, .hljs-selector-attr');
    const comments = el.querySelectorAll('.hljs-comment, .hljs-quote');
    const functions = el.querySelectorAll('.hljs-function, .hljs-title, .hljs-section');
    const numbers = el.querySelectorAll('.hljs-number, .hljs-literal');
    const variables = el.querySelectorAll('.hljs-variable, .hljs-params, .hljs-class');
    
    keywords.forEach(elem => { elem.style.color = '#569CD6'; elem.style.fontWeight = 'bold'; });
    strings.forEach(elem => { elem.style.color = '#CE9178'; });
    comments.forEach(elem => { elem.style.color = '#6A9955'; elem.style.fontStyle = 'italic'; });
    functions.forEach(elem => { elem.style.color = '#DCDCAA'; });
    numbers.forEach(elem => { elem.style.color = '#B5CEA8'; });
    variables.forEach(elem => { elem.style.color = '#9CDCFE'; });

    if (parentPre && !parentPre.querySelector('.copy-btn')) {
        const btn = document.createElement('button');
        btn.className = 'copy-btn absolute top-2 right-2 bg-gray-700 hover:bg-gray-600 text-white border border-gray-500 rounded px-2 py-1 text-xs transition-all';
        btn.innerText = '복사';
        btn.onclick = function() {
            navigator.clipboard.writeText(el.innerText);
            btn.innerText = '복사됨!';
            setTimeout(()=>{btn.innerText='복사';}, 1500);
        };
        parentPre.appendChild(btn);
    }
}

function isModifyRequest(text) {
    // 간단한 규칙: "고쳐줘", "수정", "추가", "변경" 등 포함 시 수정 요청으로 간주
    return /고쳐줘|수정|추가|변경|리팩터|refactor|fix|add|modify/i.test(text);
}

// 새 채팅 생성 기능
document.getElementById('new-chat-btn').addEventListener('click', async function() {
    const button = this;
    const originalText = button.innerHTML;
    
    try {
        // 버튼 비활성화 및 로딩 상태 표시
        button.disabled = true;
        button.innerHTML = '<span class="material-icons text-sm mr-1 animate-spin">refresh</span>생성 중...';
        
        const response = await fetch('/new-chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                repo_url: '{{ repo_url }}',
                token: '{{ token }}' // 필요시 토큰 정보를 가져오는 방법 변경
            })
        });
        
        const result = await response.json();
        
        if (result.status === '성공') {
            showToast('새 채팅이 생성되었습니다.');
            
            // 새 채팅 세션으로 이동하되 기존 채팅 기록은 유지됨
            // history.pushState 사용으로 페이지 새로고침 없이 URL만 변경
            const newUrl = `/chat/${result.session_id}`;
            history.pushState({session_id: result.session_id}, '', newUrl);
            
            // 채팅창 초기화
            document.getElementById('chat-box').innerHTML = `
            <div class="msg-ai mb-6">
              <div>
                <p>안녕하세요! GitHub 저장소의 코드에 대해 질문하거나 코드 수정을 요청해보세요. 언제든지 도와드리겠습니다! 파일 구조, 함수의 목적, 버그 해결 방법 등 어떤 질문이든 가능합니다.</p>
              </div>
            </div>`;
            
            // 채팅 세션 목록 업데이트
            updateChatSessionsList(result.session_id);
            
            // 입력창 초기화
            document.getElementById('user-input').value = '';
            
        } else if (result.error_code === 'repo_not_analyzed') {
            // 분석되지 않은 저장소인 경우 특별 처리
            const shouldAnalyze = confirm(
                `${result.error}\n\n저장소를 분석하러 가시겠습니까?`
            );
            if (shouldAnalyze) {
                window.location.href = '/';
            }
        } else {
            // 다른 오류의 경우 더 자세한 정보 제공
            let errorMessage = '새 채팅 생성 실패: ' + (result.error || '알 수 없는 오류');
            if (result.error && result.error.includes('ChromaDB')) {
                errorMessage += '\n\n💡 해결 방법:\n1. 기존 채팅 세션을 사용해보세요\n2. 저장소를 다시 분석해보세요\n3. 페이지를 새로고침해보세요';
            }
            alert(errorMessage);
        }
    } catch (error) {
        console.error('새 채팅 생성 오류:', error);
        alert('새 채팅 생성 중 오류가 발생했습니다: ' + error.message);
    } finally {
        // 버튼 상태 복원
        button.disabled = false;
        button.innerHTML = originalText;
    }
});

// 채팅 세션 목록 업데이트 함수
async function updateChatSessionsList(currentSessionId) {
    try {
        // 채팅 세션 목록 가져오기
        const response = await fetch(`/chat-sessions?repo_url={{ repo_url }}`);
        const result = await response.json();
        
        if (result.status === '성공' && result.chat_sessions) {
            const chatSessionsList = document.getElementById('chat-sessions-list');
            chatSessionsList.innerHTML = '';
            
            if (result.chat_sessions.length === 0) {
                chatSessionsList.innerHTML = '<div class="text-sm text-gray-500 italic p-2">채팅 기록이 없습니다</div>';
                return;
            }
            
            // 채팅 세션 목록 표시
            result.chat_sessions.forEach((chatSession, index) => {
                const isActive = chatSession.session_id === currentSessionId;
                const sessionItem = document.createElement('div');
                sessionItem.className = `chat-session-item p-2 rounded-md cursor-pointer hover:bg-gray-700 transition-colors duration-150 ${isActive ? 'bg-gray-700' : ''}`;
                sessionItem.dataset.sessionId = chatSession.session_id;
                
                const date = new Date(chatSession.created_at);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                
                sessionItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="text-sm font-medium truncate">채팅 #${index + 1}</div>
                        <div class="text-xs text-gray-400">${formattedDate}</div>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">
                        메시지: ${chatSession.message_count !== null ? chatSession.message_count : 0}개
                    </div>
                `;
                
                // 채팅 세션 클릭 이벤트
                sessionItem.addEventListener('click', function() {
                    window.location.href = `/chat/${chatSession.session_id}`;
                });
                
                chatSessionsList.appendChild(sessionItem);
            });
        } else {
            console.error('채팅 세션 목록 가져오기 실패:', result.error || '알 수 없는 오류');
        }
    } catch (error) {
        console.error('채팅 세션 목록 업데이트 오류:', error);
    }
}

// 기존 채팅 세션 아이템에 클릭 이벤트 추가
document.querySelectorAll('.chat-session-item').forEach(item => {
    item.addEventListener('click', function() {
        const sessionId = this.dataset.sessionId;
        if (sessionId) {
            window.location.href = `/chat/${sessionId}`;
        }
    });
});

// 기존 채팅 기능
document.getElementById('chat-form').onsubmit = async function(e) {
    e.preventDefault();
    const input = document.getElementById('user-input');
    const userMsg = input.value;
    
    // 선택된 파일 컨텍스트 정보 먼저 생성
    let contextInfo = '';
    if (selectedFiles.length > 0) {
        contextInfo = selectedFiles.map(file => file.path).join(', ');
    }
    
    // 사용자 메시지 추가 (컨텍스트 정보 포함)
    let userMessageHtml = `<div class="msg-user flex justify-end mb-2"><div class="bg-gray-700 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-yellow-300">나:</b> ${escapeHtml(userMsg)}`;
    
    if (contextInfo) {
        userMessageHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-300"><span class="material-icons text-xs mr-1">description</span>선택된 파일: ${escapeHtml(contextInfo)}</div>`;
    }
    
    userMessageHtml += `</div></div>`;
    chatBox.innerHTML += userMessageHtml;
    input.value = '';
    
    // 질문 후 컨텍스트 초기화
    // 메시지 전송 후 선택된 파일 컨텍스트 유지 (사용자가 명시적으로 삭제할 때까지)
    // selectedFiles를 자동으로 초기화하지 않음으로써 연속적인 질문 시 컨텍스트 유지
    console.log('[DEBUG] 메시지 전송 완료, 컨텍스트 유지:', selectedFiles.length, '개 파일');
    
    // AI 응답 로딩 애니메이션 추가
    const loadingId = 'loading-' + Date.now();
    chatBox.innerHTML += `
      <div id="${loadingId}" class="msg-ai flex justify-start mb-2">
        <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow">
          <b class="text-blue-300">AI:</b>
          <div class="loading-wrapper">
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-circle"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
            <div class="loading-shadow"></div>
          </div>
        </div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
    
    let url = '/chat';
    if (isModifyRequest(userMsg)) url = '/modify_request';
    // 선택된 파일 컨텍스트 포함하여 메시지 구성
    let messageWithContext = userMsg;
    if (selectedFiles.length > 0) {
        messageWithContext += '\n\n[선택된 파일 컨텍스트]\n';
        selectedFiles.forEach(file => {
            messageWithContext += `\n--- ${file.path} (브랜치: ${file.branch}) ---\n`;
            messageWithContext += file.content + '\n';
        });
    }
    
    const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            session_id: '{{ session_id }}',
            message: messageWithContext
        })
    });
    const data = await res.json();
    // 세션 오류 처리
    if (data.error === 'session_not_found' || data.error === 'search_error') {
        chatBox.innerHTML += `<div class="bg-red-500 text-white rounded-lg p-4 my-2 text-center"><b>AI:</b> ${marked.parse(data.answer)}</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
        setTimeout(() => {
            alert('세션이 만료되었거나 오류가 발생했습니다. 메인 페이지로 이동합니다.');
            window.location.href = '/';
        }, 3000);
        return;
    }
    // 일반 응답 처리
    if (data.answer) {
        // 로딩 애니메이션 제거
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // AI 응답 추가
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${marked.parse(data.answer)} </div></div>`;
        // 새로 추가된 메시지 내의 모든 코드 블록에 스타일 적용
        document.querySelectorAll('#chat-box .msg-ai:last-child pre code').forEach(styleCodeBlock);
    }
    // 코드 수정 처리
    if (data.modified_code) {
        // 로딩 애니메이션 제거
        const loadingElement = document.getElementById(loadingId);
        if (loadingElement) {
            loadingElement.remove();
        }
        
        // 이전 codePreview 요소는 더 이상 사용하지 않으므로 숨김 처리 (또는 완전히 제거 가능)
        const oldCodePreviewEl = document.getElementById('code-preview');
        if (oldCodePreviewEl) oldCodePreviewEl.style.display = 'none';
        
        lastFileName = data.file_name || '';
        lastModifiedCode = data.modified_code || ''; // 원본 코드는 HTML 이스케이프 처리 예정
        const checkPushRes = await fetch('/check_push_intent', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: '{{ session_id }}',
                message: userMsg
            })
        });
        const pushData = await checkPushRes.json();
        const hasPushIntent = pushData.has_push_intent;
        const hasToken = pushData.token_exists;
        let actionButtons = '';
        if (hasPushIntent) {
            if (hasToken) {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>로컬에만 적용</button>
                        <button id='push-btn' class='bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>GitHub에 적용(push)</button>
                    </div>
                    <div id="confirmation-msg" class="bg-blue-100 text-blue-900 rounded-lg p-4 my-2" style="display:none;">
                        <p class="font-bold mb-2">GitHub 저장소에 변경사항을 적용하시겠습니까?</p>
                        <p>브랜치: <code>test</code> | 파일: <code>${lastFileName}</code></p>
                        <div class="flex gap-2 mt-2">
                            <button id="confirm-push" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200">적용</button>
                            <button id="cancel-push" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200">취소</button>
                        </div>
                    </div>`;
            } else {
                actionButtons = `
                    <div class="flex gap-2 mb-3">
                        <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>로컬에만 적용</button>
                    </div>
                    <div class="bg-yellow-100 text-yellow-900 rounded-lg p-4 my-2">
                        <strong>GitHub 반영 기능은 토큰 입력 시에만 가능합니다.</strong><br>
                        시작 화면에서 GitHub Personal Access Token을 입력해주세요.
                    </div>`;
            }
        } else {
            actionButtons = `
                <div class="flex gap-2 mb-3">
                    <button id='apply-btn' class='bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-200'>적용</button>
                </div>`;
        }
        // 코드 미리보기 내용을 채팅창에 추가
        chatBox.innerHTML += `
          <div class="msg-ai flex justify-start mb-2">
            <div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[90%] font-medium shadow" style="overflow-wrap: break-word; word-break: break-word;">
              <b class="text-blue-300">AI:</b> 아래와 같이 코드를 수정했습니다:
              <div class="mb-2 mt-3 text-gray-300"><b>파일명:</b> ${lastFileName}</div>
              <pre><code class="language-python">${escapeHtml(lastModifiedCode)}</code></pre>
              ${actionButtons}
            </div>
          </div>`;
        // 새로 추가된 메시지 내의 모든 코드 블록에 스타일 적용
        document.querySelectorAll('#chat-box .msg-ai:last-child pre code').forEach(styleCodeBlock);
        
        // 버튼 이벤트 리스너 추가
        chatBox.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'close-preview-btn') {
                // 미리보기를 닫는 기능은 더 이상 필요하지 않지만, 버튼이 있을 경우 오류 방지
                codePreview.style.display = 'none';
            }
        });
        
        // GitHub 푸시 버튼 기능 구현
        // GitHub 푸시 버튼 기능 구현 - 이벤트 위임 사용하여 동적 생성된 버튼에 이벤트 적용
        chatBox.addEventListener('click', function(e) {
            // 푸시 버튼 클릭 처리
            if (e.target && e.target.id === 'push-btn') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'block';
            }
            
            // 확인 버튼 처리 - 이벤트 위임 사용
            // 확인 버튼 클릭 처리
            if (e.target && e.target.id === 'confirm-push') {
                // 추가 로딩 애니메이션 제거 (로딩 ID가 없을 수 있어서 모든 로딩 애니메이션 제거)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                
                (async function() {
                    try {
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = true;
                            pushBtn.innerText = '처리 중...';
                        }
                        
                        const pushRes = await fetch('/push_to_github', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                session_id: '{{ session_id }}',
                                file_name: lastFileName,
                                modified_code: lastModifiedCode
                            })
                        });
                        
                        const result = await pushRes.json();
                        
                        if (result.success) {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                                  GitHub에 성공적으로 코드가 적용되었습니다.
                                </div>
                              </div>`;
                        } else {
                            chatBox.innerHTML += `
                              <div class="msg-system flex justify-center my-3">
                                <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                                  <i class="material-icons align-middle text-sm mr-1">error</i>
                                  GitHub 적용 실패: ${result.error || '알 수 없는 오류'}
                                </div>
                              </div>`;
                        }
                    } catch (error) {
                        console.error('GitHub 푸시 오류:', error);
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              GitHub 적용 중 오류가 발생했습니다.
                            </div>
                          </div>`;
                    } finally {
                        const confirmMsg = document.getElementById('confirmation-msg');
                        if (confirmMsg) confirmMsg.style.display = 'none';
                        
                        const pushBtn = document.getElementById('push-btn');
                        if (pushBtn) {
                            pushBtn.disabled = false;
                            pushBtn.innerText = 'GitHub에 적용(push)';
                        }
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                })();
            }
            
            // 취소 버튼 처리
            if (e.target && e.target.id === 'cancel-push') {
                const confirmMsg = document.getElementById('confirmation-msg');
                if (confirmMsg) confirmMsg.style.display = 'none';
            }
        });
        
        // 로컬 적용 버튼 기능 구현 - 이벤트 위임 사용
        chatBox.addEventListener('click', async function(e) {
            // 로컬 적용 버튼 클릭 처리
            if (e.target && e.target.id === 'apply-btn') {
                // 추가 로딩 애니메이션 제거 (로딩 ID가 없을 수 있어서 모든 로딩 애니메이션 제거)
                document.querySelectorAll('[id^="loading-"]').forEach(el => el.remove());
                try {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = true;
                        applyBtn.innerText = '적용 중...';
                    }
                    
                    const applyRes = await fetch('/apply_local', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            session_id: '{{ session_id }}',
                            file_name: lastFileName,
                            modified_code: lastModifiedCode
                        })
                    });
                    
                    const result = await applyRes.json();
                    
                    if (result.success) {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">check_circle</i>
                              로컬에 성공적으로 코드가 적용되었습니다.
                            </div>
                          </div>`;
                    } else {
                        chatBox.innerHTML += `
                          <div class="msg-system flex justify-center my-3">
                            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                              <i class="material-icons align-middle text-sm mr-1">error</i>
                              로컬 적용 실패: ${result.error || '알 수 없는 오류'}
                            </div>
                          </div>`;
                    }
                } catch (error) {
                    console.error('로컬 적용 오류:', error);
                    chatBox.innerHTML += `
                      <div class="msg-system flex justify-center my-3">
                        <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 text-sm font-medium">
                          <i class="material-icons align-middle text-sm mr-1">error</i>
                          로컬 적용 중 오류가 발생했습니다.
                        </div>
                      </div>`;
                } finally {
                    const applyBtn = document.getElementById('apply-btn');
                    if (applyBtn) {
                        applyBtn.disabled = false;
                        applyBtn.innerText = '로컬에만 적용';
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            }
        });
        }
    chatBox.scrollTop = chatBox.scrollHeight;
}

// 페이지 로드 시 채팅 기록 불러오기
window.addEventListener('load', async function() {
    try {
        // 채팅 기록 불러오기
        const response = await fetch(`/get_chat_history?session_id={{ session_id }}`);
        const result = await response.json();
        
        if (result.status === '성공' && result.chat_history && result.chat_history.length > 0) {
            // 채팅 기록 표시
            chatBox.innerHTML = ''; // 기존 웰컴 메시지 제거
            
            // 채팅 내역이 없는 경우 표시할 메시지
            if (result.chat_history.length === 0) {
                chatBox.innerHTML += `<div class="msg-ai mb-6">
                    <div>
                        <p>안녕하세요! GitHub 저장소의 코드에 대해 질문하거나 코드 수정을 요청해보세요. 언제든지 도와드리겠습니다! 파일 구조, 함수의 목적, 버그 해결 방법 등 어떤 질문이든 가능합니다.</p>
  </div>
                </div>`;
            } else {
                result.chat_history.forEach(msg => {
                    try {
                        if (msg.role === 'user') {
                            // 사용자 메시지 - 컨텍스트 정보 분리 처리
                            let userMessage = msg.content;
                            let contextInfo = '';
                            
                            console.log(`[DEBUG] 원본 사용자 메시지:`, userMessage);
                            
                                        // 컨텍스트 정보 추출 및 처리 (여러 패턴 지원)
            if (userMessage.includes('[선택된 파일 컨텍스트]')) {
                // 패턴 1: [선택된 파일 컨텍스트] 형식
                console.log('[DEBUG] 패턴 1 매칭: [선택된 파일 컨텍스트]');
                const parts = userMessage.split('\n\n[선택된 파일 컨텍스트]\n');
                if (parts.length > 1) {
                    userMessage = parts[0];  // 질문 부분만
                    const contextPart = parts[1];
                    
                    // "--- 파일명 (브랜치: 브랜치명) ---" 패턴에서 파일명만 추출
                    const fileMatches = contextPart.match(/--- (.+?) \(브랜치: .+?\) ---/g);
                    if (fileMatches) {
                        const fileNames = fileMatches.map(match => {
                            const fileName = match.match(/--- (.+?) \(브랜치:/)[1];
                            return fileName.trim();
                        }).filter(file => file);
                        contextInfo = fileNames.join(', ');
                    }
                }
            }
            // 패턴 2: "[선택된 파일: 파일명]" 형식 (기존 저장 형식)
            else if (userMessage.includes('[선택된 파일:')) {
                console.log('[DEBUG] 패턴 2 매칭: [선택된 파일:]');
                const contextMatch = userMessage.match(/\[선택된 파일:\s*([^\]]+)\]/);
                if (contextMatch) {
                    contextInfo = contextMatch[1].trim();
                    // 메시지에서 컨텍스트 정보 제거하여 질문 부분만 표시
                    userMessage = userMessage.replace(/\n*\[선택된 파일:[^\]]+\]/g, '').trim();
                }
            }
            // 패턴 3: "[컨텍스트 파일: 파일명]" 형식 (새로운 저장 형식)
            else if (userMessage.includes('[컨텍스트 파일:')) {
                console.log('[DEBUG] 패턴 3 매칭: [컨텍스트 파일:]');
                const contextMatch = userMessage.match(/\[컨텍스트 파일:\s*([^\]]+)\]/);
                if (contextMatch) {
                    contextInfo = contextMatch[1].trim();
                    // 메시지에서 컨텍스트 정보 제거하여 질문 부분만 표시
                    userMessage = userMessage.replace(/\n*\[컨텍스트 파일:[^\]]+\]/g, '').trim();
                }
            }
            // 패턴 4: 실제 컨텍스트 내용이 포함된 경우 (사용자가 직접 선택한 경우)
            else if (userMessage.includes('--- ') && userMessage.includes(' (브랜치: ')) {
                console.log('[DEBUG] 패턴 4 매칭: 실제 파일 내용 포함');
                // 실제 파일 내용이 포함된 메시지에서 파일명 추출
                const fileMatches = userMessage.match(/--- (.+?) \(브랜치: .+?\) ---/g);
                if (fileMatches) {
                    const fileNames = fileMatches.map(match => {
                        const fileName = match.match(/--- (.+?) \(브랜치:/)[1];
                        return fileName.trim();
                    }).filter(file => file);
                    contextInfo = fileNames.join(', ');
                    
                    // 질문 부분만 추출 (첫 번째 컨텍스트 마커 이전까지)
                    const firstContextIndex = userMessage.indexOf('\n\n--- ');
                    if (firstContextIndex > 0) {
                        userMessage = userMessage.substring(0, firstContextIndex).trim();
                    }
                }
            }
            // 패턴 5: AI 응답에서 컨텍스트 정보 역추적 (새로운 기능)
            else {
                console.log('[DEBUG] 직접 컨텍스트 정보가 없음, AI 응답에서 역추적 시도');
                // 현재 메시지의 인덱스 찾기
                const currentIndex = result.chat_history.findIndex(m => m === msg);
                // 바로 다음 AI 응답 확인
                if (currentIndex >= 0 && currentIndex + 1 < result.chat_history.length) {
                    const nextMsg = result.chat_history[currentIndex + 1];
                    if (nextMsg.role === 'assistant') {
                        // AI 응답에서 파일명 패턴 찾기
                        const filePatterns = [
                            /`([^`]+\.py)`/g,
                            /`([^`]+\.js)`/g,
                            /`([^`]+\.ts)`/g,
                            /`([^`]+\.java)`/g,
                            /`([^`]+\.cpp)`/g,
                            /`([^`]+\.c)`/g,
                            /`([^`]+\.h)`/g,
                            /파일.*?`([^`]+\.\w+)`/g,
                            /분석.*?`([^`]+\.\w+)`/g
                        ];
                        
                        let foundFiles = new Set();
                        filePatterns.forEach(pattern => {
                            let match;
                            while ((match = pattern.exec(nextMsg.content)) !== null) {
                                foundFiles.add(match[1]);
                            }
                        });
                        
                        if (foundFiles.size > 0) {
                            contextInfo = Array.from(foundFiles).join(', ');
                            console.log('[DEBUG] AI 응답에서 역추적한 컨텍스트:', contextInfo);
                        }
                    }
                }
            }
                            
                            console.log(`[DEBUG] 처리된 사용자 메시지:`, userMessage);
                            console.log(`[DEBUG] 추출된 컨텍스트 정보:`, contextInfo);
                            
                            let userMessageHtml = `<div class="msg-user flex justify-end mb-2"><div class="bg-gray-700 text-white rounded-2xl rounded-br-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-yellow-300">나:</b> ${escapeHtml(userMessage)}`;
                            
                            if (contextInfo) {
                                userMessageHtml += `<div class="mt-2 pt-2 border-t border-gray-600 text-xs text-gray-300"><span class="material-icons text-xs mr-1">description</span>선택된 파일: ${escapeHtml(contextInfo)}</div>`;
                            }
                            
                            userMessageHtml += `</div></div>`;
                            chatBox.innerHTML += userMessageHtml;
                        } else if (msg.role === 'assistant') {
                            // AI 응답 처리 개선 - 에러 방지를 위한 try-catch 추가
                            try {
                                const parsedContent = marked.parse(msg.content);
                                chatBox.innerHTML += `<div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${parsedContent} </div></div>`;
                            } catch (parseError) {
                                console.error('마크다운 파싱 오류:', parseError);
                                // 파싱 실패 시 원본 내용 그대로 표시
                                chatBox.innerHTML += `<div class="msg-ai flex justify-start mb-2"><div class="bg-gray-600 text-white rounded-2xl rounded-bl-none px-5 py-3 max-w-[70%] font-medium shadow"> <b class="text-blue-300">AI:</b> ${msg.content} </div></div>`;
                            }
                        }
                    } catch (msgError) {
                        console.error('메시지 처리 오류:', msgError, msg);
                    }
                });
            }
            
            // 코드 블록에 스타일 적용
            document.querySelectorAll('#chat-box pre code').forEach(block => {
                try {
                    styleCodeBlock(block);
                } catch (styleError) {
                    console.error('코드 블록 스타일 적용 오류:', styleError);
                }
            });
        } else {
            // 채팅 내역이 없거나 오류 발생 시 기본 메시지 유지
            console.log('표시할 채팅 내역이 없습니다.');
        }
    } catch (error) {
        console.error('채팅 기록 불러오기 오류:', error);
    }
    
    // 채팅 메시지 영역 최하단으로 스크롤
    chatBox.scrollTop = chatBox.scrollHeight;
    
    // 채팅 기록 로드 완료 후 파일 탐색기 초기화
    try {
        await initFileExplorer();
        console.log('[DEBUG] 파일 탐색기 초기화 완료');
    } catch (error) {
        console.error('[ERROR] 파일 탐색기 초기화 실패:', error);
    }
    
    // 세션 관리 모드 토글 이벤트 처리
    const editModeToggle = document.getElementById('edit-mode-toggle');
    editModeToggle.addEventListener('change', function() {
        const sessionControls = document.querySelectorAll('.session-controls');
        const chatSessionItems = document.querySelectorAll('.chat-session-item');
        
        if (this.checked) {
            // 관리 모드 활성화
            sessionControls.forEach(control => control.classList.remove('hidden'));
            chatSessionItems.forEach(item => {
                item.style.paddingRight = '130px'; // 컨트롤 버튼 공간 확보
                item.classList.add('edit-mode');
            });
        } else {
            // 관리 모드 비활성화
            sessionControls.forEach(control => control.classList.add('hidden'));
            chatSessionItems.forEach(item => {
                item.style.paddingRight = '';
                item.classList.remove('edit-mode');
            });
        }
    });
    
    // 세션 관리 버튼 이벤트 위임으로 처리
    document.getElementById('chat-sessions-list').addEventListener('click', async function(e) {
        // 기본 클릭 동작은 관리 모드가 아닐 때만 작동
        if (!editModeToggle.checked && e.target.closest('.chat-session-item')) {
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            if (sessionId) {
                window.location.href = `/chat/${sessionId}`;
            }
            return;
        }
        
        // 이름 변경 버튼 처리
        if (e.target.closest('.rename-session')) {
            e.stopPropagation(); // 상위 요소 클릭 이벤트 방지
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            const nameElement = sessionItem.querySelector('.chat-session-name');
            const currentName = nameElement.textContent;
            
            const newName = prompt('새 채팅 세션 이름을 입력하세요:', currentName);
            if (newName && newName.trim() !== '') {
                try {
                    const response = await fetch('/rename-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: sessionId, new_name: newName })
                    });
                    
                    const result = await response.json();
                    if (result.status === '성공') {
                        nameElement.textContent = newName;
                    } else {
                        alert('이름 변경 실패: ' + (result.error || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('이름 변경 오류:', error);
                    alert('이름 변경 중 오류가 발생했습니다.');
                }
            }
        }
        
        // 위로 이동 버튼 처리
        if (e.target.closest('.move-up-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const prevItem = sessionItem.previousElementSibling;
            
            if (prevItem && prevItem.classList.contains('chat-session-item')) {
                try {
                    const sessionId = sessionItem.dataset.sessionId;
                    const prevSessionId = prevItem.dataset.sessionId;
                    
                    const response = await fetch('/reorder-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            session_id: sessionId, 
                            target_position: 'up',
                            reference_session_id: prevSessionId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === '성공') {
                        // DOM에서 순서 변경
                        sessionItem.parentNode.insertBefore(sessionItem, prevItem);
                    } else {
                        alert('순서 변경 실패: ' + (result.error || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('순서 변경 오류:', error);
                    alert('순서 변경 중 오류가 발생했습니다.');
                }
            }
        }
        
        // 아래로 이동 버튼 처리
        if (e.target.closest('.move-down-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const nextItem = sessionItem.nextElementSibling;
            
            if (nextItem && nextItem.classList.contains('chat-session-item')) {
                try {
                    const sessionId = sessionItem.dataset.sessionId;
                    const nextSessionId = nextItem.dataset.sessionId;
                    
                    const response = await fetch('/reorder-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            session_id: sessionId, 
                            target_position: 'down',
                            reference_session_id: nextSessionId
                        })
                    });
                    
                    const result = await response.json();
                    if (result.status === '성공') {
                        // DOM에서 순서 변경
                        sessionItem.parentNode.insertBefore(nextItem, sessionItem);
                    } else {
                        alert('순서 변경 실패: ' + (result.error || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('순서 변경 오류:', error);
                    alert('순서 변경 중 오류가 발생했습니다.');
                }
            }
        }
        
        // MD 추출 버튼 처리
        if (e.target.closest('.export-md-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            
            try {
                const response = await fetch('/export-chat-md', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `chat-session-${sessionId}.md`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // 성공 메시지 표시
                    showToast('채팅 내역이 MD 파일로 다운로드되었습니다.');
                } else {
                    const result = await response.json();
                    alert('MD 추출 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('MD 추출 오류:', error);
                alert('MD 추출 중 오류가 발생했습니다.');
            }
        }
        
        // 삭제 버튼 처리
        if (e.target.closest('.delete-session')) {
            e.stopPropagation();
            const sessionItem = e.target.closest('.chat-session-item');
            const sessionId = sessionItem.dataset.sessionId;
            const deleteButton = e.target.closest('.delete-session');
            
            if (confirm('이 채팅 세션을 삭제하시겠습니까?\n\n경고: 이 작업은 되돌릴 수 없습니다.')) {
                try {
                    // 삭제 버튼 비활성화
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">hourglass_empty</span>';
                    
                    const response = await fetch('/delete-chat-session', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ session_id: sessionId })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.status === '성공') {
                            showToast('채팅 세션이 삭제되었습니다.');
                            
                            // 현재 세션이 삭제된 경우 첫 번째 세션으로 이동하거나 홈으로 이동
                            if (sessionId === '{{ session_id }}') {
                                if (result.next_session_id) {
                                    window.location.href = `/chat/${result.next_session_id}`;
                                } else {
                                    window.location.href = '/';
                                }
                            } else {
                                // 다른 세션이 삭제된 경우 현재 페이지에서 해당 항목만 제거
                                sessionItem.style.transition = 'opacity 0.3s ease-out';
                                sessionItem.style.opacity = '0';
                                setTimeout(() => {
                                    sessionItem.remove();
                                }, 300);
                            }
                        } else {
                            alert('삭제 실패: ' + (result.error || '알 수 없는 오류'));
                            // 버튼 복원
                            deleteButton.disabled = false;
                            deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">delete</span>';
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('삭제 오류:', error);
                    alert(`삭제 중 오류가 발생했습니다: ${error.message}`);
                    // 버튼 복원
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = '<span class="material-icons" style="font-size: 14px;">delete</span>';
                }
            }
        }
    });

    // 브랜치 및 파일 탐색 기능 초기화는 채팅 기록 로드 후에 실행
    // initFileExplorer();
});

// 선택된 파일들을 저장하는 전역 변수
let selectedFiles = [];

// 파일 탐색기 초기화 함수
async function initFileExplorer() {
    const sessionId = '{{ session_id }}';
    const branchSelector = document.getElementById('branch-selector');
    const fileTree = document.getElementById('file-tree');
    const fileTreeLoading = document.getElementById('file-tree-loading');
    const toggleButton = document.getElementById('toggle-file-explorer');
    const showButton = document.getElementById('show-file-explorer-btn');
    const fileExplorer = document.getElementById('file-explorer');
    const showFileExplorer = document.getElementById('show-file-explorer');
    
    // 파일 탐색기 숨기기 기능
    toggleButton.addEventListener('click', function() {
        fileExplorer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
        fileExplorer.style.transform = 'translateX(-100%)';
        fileExplorer.style.opacity = '0';
        
        setTimeout(() => {
            fileExplorer.style.display = 'none';
            showFileExplorer.style.display = 'flex';
            showFileExplorer.style.opacity = '0';
            showFileExplorer.style.transform = 'translateX(-20px)';
            
            // 애니메이션으로 나타나기
            setTimeout(() => {
                showFileExplorer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                showFileExplorer.style.transform = 'translateX(0)';
                showFileExplorer.style.opacity = '1';
            }, 50);
        }, 300);
    });
    
    // 파일 탐색기 보이기 기능
    showButton.addEventListener('click', function() {
        showFileExplorer.style.transition = 'transform 0.3s ease-in-out, opacity 0.3s ease-in-out';
        showFileExplorer.style.transform = 'translateX(-20px)';
        showFileExplorer.style.opacity = '0';
        
        setTimeout(() => {
            showFileExplorer.style.display = 'none';
            fileExplorer.style.display = 'flex';
            fileExplorer.style.opacity = '0';
            fileExplorer.style.transform = 'translateX(-100%)';
            
            // 애니메이션으로 나타나기
            setTimeout(() => {
                fileExplorer.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                fileExplorer.style.transform = 'translateX(0)';
                fileExplorer.style.opacity = '1';
            }, 50);
        }, 300);
    });
    
    // 선택된 파일 컨텍스트 관리
    initSelectedFilesContext();
    
    // 채팅 기록 정리 버튼 이벤트
    document.getElementById('cleanup-context-btn').addEventListener('click', async function() {
        if (confirm('채팅 기록에서 불필요한 컨텍스트 정보를 정리하시겠습니까?\n(실제로 파일을 선택한 질문만 컨텍스트가 유지됩니다)')) {
            try {
                this.disabled = true;
                this.innerHTML = '<span class="material-icons text-sm mr-1">hourglass_empty</span>정리 중...';
                
                const response = await fetch('/cleanup-chat-context', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ session_id: '{{ session_id }}' })
                });
                
                const result = await response.json();
                if (result.status === '성공') {
                    showToast(`채팅 기록 정리 완료: ${result.updated_count}개 메시지 정리됨`);
                    // 페이지 새로고침으로 정리된 채팅 기록 표시
                    window.location.reload();
                } else {
                    alert('정리 실패: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                console.error('채팅 기록 정리 오류:', error);
                alert('정리 중 오류가 발생했습니다.');
            } finally {
                this.disabled = false;
                this.innerHTML = '<span class="material-icons text-sm mr-1">cleaning_services</span>채팅 기록 정리';
            }
        }
    });
    
    // 브랜치 목록 로드 (재시도 로직 포함)
    async function loadBranches(retryCount = 0) {
        const maxRetries = 3;
        try {
            console.log(`[DEBUG] 브랜치 로드 시도 ${retryCount + 1}/${maxRetries + 1}`);
            branchSelector.innerHTML = '<option value="">브랜치 로딩 중...</option>';
            
            const response = await fetch(`/api/branches/${sessionId}`, {
                method: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                console.log(`[DEBUG] 브랜치 로드 성공: ${result.branches.length}개 브랜치`);
                branchSelector.innerHTML = '<option value="">브랜치를 선택하세요...</option>';
                result.branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.name;
                    option.textContent = branch.name;
                    branchSelector.appendChild(option);
                });
                
                // 기본 브랜치 선택 (main 또는 master)
                const defaultBranch = result.branches.find(b => b.name === 'main') || 
                                    result.branches.find(b => b.name === 'master') || 
                                    result.branches[0];
                if (defaultBranch) {
                    branchSelector.value = defaultBranch.name;
                    await loadFileTree(sessionId, defaultBranch.name);
                }
            } else {
                throw new Error(result.error || '알 수 없는 오류');
            }
        } catch (error) {
            console.error(`[ERROR] 브랜치 로드 실패 (시도 ${retryCount + 1}):`, error);
            
            if (retryCount < maxRetries) {
                // 재시도 전 잠시 대기
                await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
                return loadBranches(retryCount + 1);
            } else {
                // 최대 재시도 횟수 초과
                branchSelector.innerHTML = '<option value="">브랜치 로드 실패 (재시도 초과)</option>';
                console.error('[ERROR] 브랜치 로드 최종 실패');
            }
        }
    }
    
    await loadBranches();
    
    // 브랜치 선택 이벤트
    branchSelector.addEventListener('change', function() {
        const selectedBranch = this.value;
        if (selectedBranch) {
            loadFileTree(sessionId, selectedBranch);
        } else {
            fileTree.innerHTML = '<div class="text-xs text-gray-500 italic p-2">브랜치를 선택하면 파일 구조가 표시됩니다</div>';
        }
    });
}

// 파일 트리 로드 함수
async function loadFileTree(sessionId, branchName) {
    const fileTree = document.getElementById('file-tree');
    const fileTreeLoading = document.getElementById('file-tree-loading');
    
    fileTreeLoading.classList.remove('hidden');
    fileTree.innerHTML = '';
    
    try {
        const response = await fetch(`/api/files/${sessionId}/${branchName}`);
        const result = await response.json();
        
        if (result.success) {
            const treeStructure = buildFileTree(result.files, result.directories);
            fileTree.innerHTML = treeStructure;
            
            // 파일 클릭 및 우클릭 이벤트 추가
            fileTree.addEventListener('click', function(e) {
                if (e.target.closest('.file-item')) {
                    const fileItem = e.target.closest('.file-item');
                    const filePath = fileItem.dataset.path;
                    showFileContent(sessionId, branchName, filePath);
                }
            });
            
            // 파일 우클릭 컨텍스트 메뉴 이벤트
            fileTree.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.file-item')) {
                    e.preventDefault();
                    const fileItem = e.target.closest('.file-item');
                    const filePath = fileItem.dataset.path;
                    addFileToContext(sessionId, branchName, filePath);
                }
            });
        } else {
            fileTree.innerHTML = `<div class="text-xs text-red-400 p-2">파일 구조 로드 실패: ${result.error}</div>`;
        }
    } catch (error) {
        console.error('파일 트리 로드 오류:', error);
        fileTree.innerHTML = '<div class="text-xs text-red-400 p-2">파일 구조 로드 오류</div>';
    } finally {
        fileTreeLoading.classList.add('hidden');
    }
}

// 파일 트리 구조 생성 함수
function buildFileTree(files, directories) {
    const tree = {};
    
    // 디렉토리 구조 생성
    directories.forEach(dir => {
        const parts = dir.path.split('/');
        let current = tree;
        parts.forEach(part => {
            if (!current[part]) {
                current[part] = { type: 'directory', children: {} };
            }
            current = current[part].children;
        });
    });
    
    // 파일 추가
    files.forEach(file => {
        const parts = file.path.split('/');
        const fileName = parts.pop();
        let current = tree;
        
        // 디렉토리 경로 생성
        parts.forEach(part => {
            if (!current[part]) {
                current[part] = { type: 'directory', children: {} };
            }
            current = current[part].children;
        });
        
        // 파일 추가
        current[fileName] = { type: 'file', path: file.path, size: file.size };
    });
    
    return renderTree(tree);
}

// 트리 렌더링 함수
function renderTree(tree, level = 0) {
    let html = '';
    const indent = '  '.repeat(level);
    
    Object.keys(tree).sort((a, b) => {
        // 디렉토리를 먼저, 그 다음 파일
        const aIsDir = tree[a].type === 'directory';
        const bIsDir = tree[b].type === 'directory';
        if (aIsDir && !bIsDir) return -1;
        if (!aIsDir && bIsDir) return 1;
        return a.localeCompare(b);
    }).forEach(name => {
        const item = tree[name];
        
        if (item.type === 'directory') {
            html += `
                <div class="directory-item" style="margin-left: ${level * 12}px;">
                    <div class="flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer text-xs" onclick="toggleDirectory(this)">
                        <span class="material-icons text-xs mr-1">folder</span>
                        <span class="text-blue-300">${name}</span>
                        <span class="material-icons text-xs ml-auto">expand_more</span>
</div>
                    <div class="directory-content hidden">
                        ${renderTree(item.children, level + 1)}
</div>
                </div>
            `;
        } else {
            const fileIcon = getFileIcon(name);
            const fileSize = formatFileSize(item.size);
            html += `
                <div class="file-item flex items-center py-1 px-2 hover:bg-gray-700 rounded cursor-pointer text-xs" 
                     style="margin-left: ${level * 12}px;" data-path="${item.path}">
                    <span class="material-icons text-xs mr-1">${fileIcon}</span>
                    <span class="text-gray-300 flex-1">${name}</span>
                    <span class="text-gray-500 text-xs ml-2">${fileSize}</span>
                </div>
            `;
        }
    });
    
    return html;
}

// 디렉토리 토글 함수
function toggleDirectory(element) {
    const content = element.nextElementSibling;
    const icon = element.querySelector('.material-icons:last-child');
    
    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        icon.textContent = 'expand_less';
    } else {
        content.classList.add('hidden');
        icon.textContent = 'expand_more';
    }
}

// 파일 아이콘 반환 함수
function getFileIcon(fileName) {
    const ext = fileName.split('.').pop().toLowerCase();
    const iconMap = {
        'py': 'code',
        'js': 'code',
        'ts': 'code',
        'html': 'web',
        'css': 'style',
        'md': 'description',
        'txt': 'description',
        'json': 'data_object',
        'yml': 'settings',
        'yaml': 'settings',
        'xml': 'code',
        'sql': 'storage',
        'sh': 'terminal',
        'bat': 'terminal',
        'dockerfile': 'docker',
        'gitignore': 'visibility_off',
        'readme': 'info'
    };
    
    return iconMap[ext] || 'insert_drive_file';
}

// 파일 크기 포맷 함수
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// 현재 표시 중인 파일 정보 저장
let currentFileInfo = null;

// 파일 내용 표시 함수
async function showFileContent(sessionId, branchName, filePath) {
    const codePreview = document.getElementById('code-preview');
    const codePreviewContent = document.getElementById('code-preview-content');
    const previewTitle = codePreview.querySelector('h3');
    
    // 미리보기 영역 표시
    codePreview.style.display = 'block';
    previewTitle.textContent = filePath;
    codePreviewContent.innerHTML = '<div class="text-gray-400">파일 내용을 불러오는 중...</div>';
    
    try {
        const response = await fetch(`/api/file-content/${sessionId}/${branchName}/${encodeURIComponent(filePath)}`);
        const result = await response.json();
        
        if (result.success) {
            const language = getLanguageFromPath(filePath);
            const escapedContent = escapeHtml(result.content);
            
            // 현재 파일 정보 저장
            currentFileInfo = {
                sessionId,
                branchName,
                filePath,
                content: result.content,
                language
            };
            
            codePreviewContent.innerHTML = `
                <pre><code class="language-${language}">${escapedContent}</code></pre>
            `;
            
            // 코드 하이라이팅 적용
            const codeBlock = codePreviewContent.querySelector('code');
            if (codeBlock) {
                hljs.highlightElement(codeBlock);
            }
        } else {
            codePreviewContent.innerHTML = `<div class="text-red-400">파일 내용 로드 실패: ${result.error}</div>`;
            currentFileInfo = null;
        }
    } catch (error) {
        console.error('파일 내용 로드 오류:', error);
        codePreviewContent.innerHTML = '<div class="text-red-400">파일 내용 로드 오류</div>';
        currentFileInfo = null;
    }
}

// 파일 경로에서 언어 추출 함수
function getLanguageFromPath(filePath) {
    const ext = filePath.split('.').pop().toLowerCase();
    const languageMap = {
        'py': 'python',
        'js': 'javascript',
        'ts': 'typescript',
        'html': 'html',
        'css': 'css',
        'md': 'markdown',
        'json': 'json',
        'yml': 'yaml',
        'yaml': 'yaml',
        'xml': 'xml',
        'sql': 'sql',
        'sh': 'bash',
        'bat': 'batch'
    };
    
    return languageMap[ext] || 'text';
}

// 코드 미리보기 관련 이벤트들
document.getElementById('close-preview').addEventListener('click', function() {
    document.getElementById('code-preview').style.display = 'none';
});

document.getElementById('fullscreen-preview').addEventListener('click', function() {
    if (currentFileInfo) {
        showFullscreenModal(currentFileInfo);
    }
});

document.getElementById('close-fullscreen').addEventListener('click', function() {
    document.getElementById('fullscreen-modal').classList.add('hidden');
});

document.getElementById('add-to-context-btn').addEventListener('click', function() {
    if (currentFileInfo) {
        addFileToContextFromModal(currentFileInfo);
    }
});

// 전체 화면 모달 표시 함수
function showFullscreenModal(fileInfo) {
    const modal = document.getElementById('fullscreen-modal');
    const title = document.getElementById('fullscreen-title');
    const content = document.getElementById('fullscreen-content');
    
    title.textContent = fileInfo.filePath;
    
    const escapedContent = escapeHtml(fileInfo.content);
    content.innerHTML = `
        <pre><code class="language-${fileInfo.language}">${escapedContent}</code></pre>
    `;
    
    // 코드 하이라이팅 적용
    const codeBlock = content.querySelector('code');
    if (codeBlock) {
        hljs.highlightElement(codeBlock);
    }
    
    modal.classList.remove('hidden');
}

// 모달에서 컨텍스트에 추가하는 함수
function addFileToContextFromModal(fileInfo) {
    // 이미 선택된 파일인지 확인
    const existingFile = selectedFiles.find(f => f.path === fileInfo.filePath);
    if (existingFile) {
        showToast('이미 선택된 파일입니다.');
        return;
    }
    
    selectedFiles.push({
        path: fileInfo.filePath,
        content: fileInfo.content,
        branch: fileInfo.branchName
    });
    updateSelectedFilesDisplay();
    
    // 성공 메시지
    showToast(`파일 "${fileInfo.filePath}"이(가) 컨텍스트에 추가되었습니다.`);
    
    // 모달 닫기
    document.getElementById('fullscreen-modal').classList.add('hidden');
}

// 선택된 파일 컨텍스트 관리 함수들
function initSelectedFilesContext() {
    // 로컬 스토리지에서 이전 선택 상태 복원
    const sessionId = '{{ session_id }}';
    const savedContext = localStorage.getItem(`selectedFiles_${sessionId}`);
    
    if (savedContext) {
        try {
            selectedFiles = JSON.parse(savedContext);
            console.log('[DEBUG] 로컬 스토리지에서 컨텍스트 복원:', selectedFiles);
        } catch (e) {
            console.error('[ERROR] 로컬 스토리지 컨텍스트 파싱 실패:', e);
            selectedFiles = [];
        }
    } else {
        selectedFiles = [];
    }
    
    updateSelectedFilesDisplay();
    
    const clearButton = document.getElementById('clear-selected-files');
    const mdFileUpload = document.getElementById('md-file-upload');
    
    clearButton.addEventListener('click', function() {
        selectedFiles = [];
        updateSelectedFilesDisplay();
        // 로컬 스토리지에서도 제거
        localStorage.removeItem(`selectedFiles_${sessionId}`);
    });
    
    // MD 파일 업로드 처리
    mdFileUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            handleMdFileUpload(file);
            // 파일 입력 초기화
            e.target.value = '';
        }
    });
}

// MD 파일 업로드 처리 함수
function handleMdFileUpload(file) {
    // 파일 크기 체크 (5MB 제한)
    if (file.size > 5 * 1024 * 1024) {
        alert('파일 크기는 5MB 이하여야 합니다.');
        return;
    }
    
    // 파일 확장자 체크
    const allowedExtensions = ['.md', '.txt'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    if (!allowedExtensions.includes(fileExtension)) {
        alert('MD 또는 TXT 파일만 업로드 가능합니다.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        
        // 이미 같은 이름의 파일이 있는지 확인
        const existingFile = selectedFiles.find(f => f.path === file.name);
        if (existingFile) {
            if (!confirm('같은 이름의 파일이 이미 있습니다. 교체하시겠습니까?')) {
                return;
            }
            // 기존 파일 제거
            selectedFiles = selectedFiles.filter(f => f.path !== file.name);
        }
        
        // 파일을 컨텍스트에 추가
        selectedFiles.push({
            path: file.name,
            content: content,
            branch: 'uploaded',
            type: 'uploaded'
        });
        
        updateSelectedFilesDisplay();
        showToast(`파일 "${file.name}"이(가) 컨텍스트에 추가되었습니다.`);
    };
    
    reader.onerror = function() {
        alert('파일을 읽는 중 오류가 발생했습니다.');
    };
    
    reader.readAsText(file, 'UTF-8');
}

function addFileToContext(sessionId, branchName, filePath) {
    // 이미 선택된 파일인지 확인
    const existingFile = selectedFiles.find(f => f.path === filePath);
    if (existingFile) {
        alert('이미 선택된 파일입니다.');
        return;
    }
    
    // 파일 내용 가져오기
    fetch(`/api/file-content/${sessionId}/${branchName}/${encodeURIComponent(filePath)}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                selectedFiles.push({
                    path: filePath,
                    content: result.content,
                    branch: branchName
                });
                updateSelectedFilesDisplay();
                
                // 성공 메시지
                showToast(`파일 "${filePath}"이(가) 컨텍스트에 추가되었습니다.`);
            } else {
                alert(`파일 내용을 가져올 수 없습니다: ${result.error}`);
            }
        })
        .catch(error => {
            console.error('파일 내용 로드 오류:', error);
            alert('파일 내용 로드 중 오류가 발생했습니다.');
        });
}

function updateSelectedFilesDisplay() {
    const filesList = document.getElementById('selected-files-list');
    const clearButton = document.getElementById('clear-selected-files');
    
    // 로컬 스토리지에 현재 상태 저장
    const sessionId = '{{ session_id }}';
    if (selectedFiles.length > 0) {
        localStorage.setItem(`selectedFiles_${sessionId}`, JSON.stringify(selectedFiles));
    } else {
        localStorage.removeItem(`selectedFiles_${sessionId}`);
    }
    
    if (selectedFiles.length === 0) {
        filesList.style.display = 'none';
        clearButton.style.display = 'none';
        return;
    }
    
    filesList.style.display = 'flex';
    clearButton.style.display = 'block';
    filesList.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const fileTag = document.createElement('div');
        const isUploaded = file.type === 'uploaded';
        const bgColor = isUploaded ? 'bg-purple-600' : 'bg-blue-600';
        const hoverColor = isUploaded ? 'hover:bg-purple-700' : 'hover:bg-blue-700';
        const icon = isUploaded ? 'upload_file' : 'description';
        
        fileTag.className = `${bgColor} text-white px-3 py-1 rounded-full text-xs flex items-center`;
        fileTag.innerHTML = `
            <span class="material-icons text-xs mr-1">${icon}</span>
            <span>${file.path}</span>
            ${isUploaded ? '<span class="text-xs ml-1 opacity-75">(업로드됨)</span>' : ''}
            <button class="ml-2 ${hoverColor} rounded-full p-1" onclick="removeFileFromContext(${index})">
                <span class="material-icons text-xs">close</span>
            </button>
        `;
        filesList.appendChild(fileTag);
    });
}

function removeFileFromContext(index) {
    selectedFiles.splice(index, 1);
    updateSelectedFilesDisplay();
}

function showToast(message) {
    // 간단한 토스트 메시지 표시
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md shadow-lg z-50';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
</body>
</html>
